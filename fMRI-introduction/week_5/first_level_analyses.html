

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>First-level analyses (using FSL) &#8212; NI-edu</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'fMRI-introduction/week_5/first_level_analyses';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Run-level analyses" href="run_level_analyses.html" />
    <link rel="prev" title="Linux and the command line" href="linux_and_the_command_line.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/fmri.gif" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/fmri.gif" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to NI-edu
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/about.html">About this course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/installation.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">fMRI-introduction</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/1_python.html">Python for (f)MRI analysis</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../other/python_recap.html">Python recap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_1/python_for_mri.html">Working with MRI data in Python (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/2_glm.html">Using the GLM to model fMRI data</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week_2/glm_part1_estimation.html">The GLM: estimation (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_3/glm_part2_inference.html">The GLM: inference (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/3_design_of_experiments_T.html">Design of experiments</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week_3/design_of_experiments.html">Design of experiments (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_3/neurodesign.html">Neurodesign (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/4_preprocessing.html">Preprocessing</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week_4/temporal_preprocessing.html">Temporal preprocessing (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_4/spatial_preprocessing.html">Spatial preprocessing (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_4/fmriprep.html">Fmriprep (T)</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../section_intros/5_multilevel.html">First &amp; run-level analyses</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="linux_and_the_command_line.html">Linux and the CMD (T)</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">First level analyses (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="run_level_analyses.html">Run-level analyses (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/6_grouplevel.html">Group-level analyses</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week_6/group_level_analyses.html">Group-level analyses (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_6/MCC.html">Multiple comparison correction (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_6/ROI_analysis.html">ROI analysis (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/7_nilearn.html">Introduction to Nilearn</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../week_7/nilearn.html">Introduction to Nilearn (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../week_7/nilearn_stats.html">Statistics with Nilearn (T)</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">fMRI-pattern-analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../fMRI-pattern-analysis/week_1/design_and_pattern_estimation.html">Design and pattern estimation (T)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI-pattern-analysis/week_2/decoding_analyses.html">Machine learning/decoding (T)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fMRI-pattern-analysis/week_3/rsa.html">Representational Similarity Analysis (T)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../misc/bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/for_educators.html">For educators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/CONDUCT.html">Code of Conduct</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/lukassnoek/NI-edu/master?urlpath=tree/NI-edu/fMRI-introduction/week_5/first_level_analyses.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://neuroimaging.lukas-snoek.com/hub/user-redirect/git-pull?repo=https%3A//github.com/lukassnoek/NI-edu&urlpath=tree/NI-edu/NI-edu/fMRI-introduction/week_5/first_level_analyses.ipynb&branch=master" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu/edit/master/NI-edu/fMRI-introduction/week_5/first_level_analyses.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu/issues/new?title=Issue%20on%20page%20%2FfMRI-introduction/week_5/first_level_analyses.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/fMRI-introduction/week_5/first_level_analyses.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>First-level analyses (using FSL)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-fsleyes">Using FSLeyes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#skullstripping">Skullstripping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-ni-edu-dataset">The “NI-edu” dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contents-of-the-dataset">Contents of the dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-acquisition-parameters">MRI acquisition parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-paradigms">Experimental paradigms</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functional-localizer-task">Functional localizer task</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#face-perception-task">Face perception task</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-fsl-feat-for-preprocessing-and-first-level-analysis">Using FSL FEAT for preprocessing and first-level analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-primer-on-the-summary-statistics-approach">A primer on the “summary statistics” approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-analyses-and-preprocessing-in-feat">First-level analyses (and preprocessing) in FEAT</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-data-tab">The “Data” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-pre-stats-tab">The “Pre-stats” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-registration-tab">The “Registration” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-stats-tab">The “Stats” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-post-stats-tab">The “Post-stats” tab</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-sense-of-feat-output">Making sense of FEAT output</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-the-report-html-file">Checking the report.html file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-out-the-results-from-feat-in-fsleyes">Checking out the results from FEAT (in FSLeyes)</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="first-level-analyses-using-fsl">
<h1>First-level analyses (using FSL)<a class="headerlink" href="#first-level-analyses-using-fsl" title="Permalink to this heading">#</a></h1>
<p>This notebook provides the first part (first-level analysis) of an introduction to multilevel models and how to implement them in FSL. The next notebook, <code class="docutils literal notranslate"><span class="pre">run_level_analysis.ipynb</span></code>, will continue with run-level analysis, and next week we will conclude this topic with group-level analyses. If you haven’t done so already, please go throught <code class="docutils literal notranslate"><span class="pre">linux_and_the_command_line</span></code> notebook first!</p>
<p>You actually know most about “first-level analyses” already, as it describes the process of modelling single-subject (single-run) timeseries data using the GLM, which we discussed at length in week 2. In this notebook, you’ll learn how to use FSL for (preprocessing and) first-level analyses. Note that there are several other excellent neuroimaging software packages, such as <a class="reference external" href="https://www.fil.ion.ucl.ac.uk/spm/">SPM</a> (Matlab-based), <a class="reference external" href="https://afni.nimh.nih.gov/">AFNI</a>, <a class="reference external" href="https://github.com/wanderine/BROCCOLI">BROCCOLI</a>, <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/">Freesurfer</a>, and <a class="reference external" href="https://nilearn.github.io/">Nilearn</a>. In fact, in week 7, there is a notebook on how to use Nilearn to fit statistical models on fMRI data.</p>
<p>We like FSL in particular, as it’s a mature and well-maintained package, free and open-source, and provides both a graphical interface and a command line interface for most of its tools.</p>
<p><strong>What you’ll learn</strong>: after this lab, you’ll be able to …</p>
<ul class="simple">
<li><p>visualize and inspect (f)MRI in FSLeyes;</p></li>
<li><p>set up a first-level model in FSL FEAT</p></li>
</ul>
<p><strong>Estimated time needed to complete</strong>: 2-4 hours</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import functionality</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-fsleyes">
<h2>Using FSLeyes<a class="headerlink" href="#using-fsleyes" title="Permalink to this heading">#</a></h2>
<p>In the previous notebook about Linux and the command line, we discussed how to use built-in Linux commands and FSL-specific commands using the command line. Now, let’s focus on using a specific FSL tool called “FSLeyes”, which is a useful program to view (f)MRI files (basically any nifti-file). We can start this graphical tool from the command line with the command: <code class="docutils literal notranslate"><span class="pre">fsleyes</span> <span class="pre">&amp;</span></code>. We append the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> to the FSLeyes command because this makes sure FSLeyes will run “in the background” and thus allows us to keep using the command line (if we would not use the <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>, FSLeyes would run be active “in your terminal”, and we wouldn’t be able to use that anymore).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Start FSLeyes from the command line.
</div><p>This should open a new window with FSLeyes. Now, let’s open a file!</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): In the menu-bar, click <tt>File</tt>, <tt>Add from file</tt>, navigate to the <tt>week_5</tt> folder, and select the file <tt>sub-02_desc-preproc_T1w.nii.gz</tt>.
</div><p>Now, FSLeyes should look similar to the figure below.</p>
<p><img alt="fsleyes" src="https://open.win.ox.ac.uk/pages/fsl/fsleyes/fsleyes/userdoc/_images/quick_start_interface_overview.png" /></p>
<center><i>Image from the <a href="https://open.win.ox.ac.uk/pages/fsl/fsleyes/fsleyes/userdoc/index.html">FSLeyes documentation</a></i></center>
<p>As you can see, FSLeyes consists of multiple views, panels, and toolbars. You should see an anatomical MRI image shown in three perspectives (sagittal, coronal, and axial) with green crosshairs in the “Ortho view”.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Try clicking at different locations in either of the three views, which should update the crosshairs and the two other views. Note that you can also use the arrow keys on your keyboard to "scroll through" the image within a particular view, although you might experience some lag doing so. Also try to zoom in using the slider in the "Ortho toolbar".
</div><p>Notice the labels on the sides of the image: <em>P</em> (posterior), <em>A</em> (anterior), <em>I</em> (inferior), <em>S</em> (superior), <em>L</em> (left), and <em>R</em> (right).</p>
<div class='alert alert-info'>
    <b>ToThink</b>: How do you think FSLeyes knows what is left and what is right (or anterior vs. posterior or inferior vs. superior)? (Think about the lab from week 1!)
</div><p>In the “Overlay toolbar”, you can adjust both the brightness and contrast of the image. One could argue that the default settings are a little bit too dark (for this scan at least).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Try increasing the brightness and the contrast by dragging the sliders to the right. Note that the "Min." and "Max." values also change if you change the brightness/contrast. You can also set these values directly.
</div><p>Importantly, while moving the location of the crosshairs, you see in the lower right corner (under the “Location panel”) that some numbers change. The left side of the panel shows you both the location of the crosshairs in “world coordinates” (relative to the isocenter of the scanner, in millimeters) and in “voxel coordinates” (starting from 0).</p>
<p>The right side of the panel shows you the voxel coordinates of the crosshairs together with the signal intensity, e.g., <span class="math notranslate nohighlight">\([156\ 123\ 87]: 600774.75\)</span>. Try changing the crosshairs from a voxel in the CSF, to a voxel in gray matter, and a voxel in white matter and observe how the signal intensity changes.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (1 point): What is the size of the three dimensions of this anatomical scan? In other words, how many slices are there in the X (saggital), Y (coronal), and Z (axial) direction? Hint: check whether FSL starts counting from 1 or from 0. Fill in your answer below (by replacing the <tt>None</tt>s).
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replace the Nones with the correct numbers</span>
<span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">Y</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">Z</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo.&#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_how_many_slices_fsleyes</span>    
<span class="n">test_how_many_slices_fsleyes</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s check out some functional data (fMRI) in FSLeyes!</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Add the <tt>sub-02_task-flocBLOCKED_space-T1w_desc-preproc+trimmed_bold.nii.gz</tt> files from the <tt>week_5</tt> directory. Note that this file has already been preprocessed by Fmriprep (including motion correction, signal distortion correction, and a rigid body registration to the anatomical file). By adding this file, you are creating an overlay, which you can see in the overlay list and choose to be visible or invisible by ticking the box next to it.
</div><p>FSLeyes neatly plots the functional data on top of the anatomical image. Note that the resolution differs between the anatomical (<span class="math notranslate nohighlight">\(1 \times 1 \times 1\)</span> mm) and functional (<span class="math notranslate nohighlight">\(2.7 \times 2.7 \times 2.97\)</span> mm)! FSLeyes still allows you to view these images on top of each other by interpolating the images.</p>
<p>Now, let’s make our view a little bit nicer.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): Set the minimum value ("Min." in the "Overlay toolbar") of the fMRI file to 8000. Make sure the <tt>sub-02_task-flocBLOCKED_space-T1w_desc-preproc+trimmed_bold.nii.gz</tt> file is actually the "active" overlay (i.e., it should be highlighted in blue in the "Overlay list").
</div><p>Setting a minimum value will threshold the image at this value, which will mask most of the background. Now, let’s also change the color scheme for the <code class="docutils literal notranslate"><span class="pre">func</span></code> file to be able to distinguish the <code class="docutils literal notranslate"><span class="pre">func</span></code> and <code class="docutils literal notranslate"><span class="pre">anat</span></code> file a little better:</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): In the "Overlay toolbar", change the colormap from "Greyscale" to "Red-Yellow".
</div><p>Now you can clearly see that setting a threshold did not mask all non-brain tissue, as some skull seems to still show “activity”!</p>
<div class='alert alert-warning'>
<b>ToDo/ToThink</b> (not graded): Set your crosshair at $[X = 27, Y = 28, Z = 17]$ (in voxel coordinates). Note that you can also fill in these values in the "Location panel" directly, which will update your crosshairs automatically. In this particular "Ortho view", which two regions seem to be affected by "signal loss"? To get a better view at the underlying anatomical image, you can either adjust the opacity (transparency) of the fMRI file in the "Overlay toolbar" or toggle the fMRI file on and off in the "Overlay list" by clicking on the Eye-icon left to the highlighted <tt>sub-02_task-flocBLOCKED...bold</tt> file.
</div><p>Again, just like with the anatomical scan, the “Location panel” shows you both the (voxel and world) coordinates as well as the signal intensity.</p>
<div class='alert alert-warning'>
<b>ToDo/ToThink</b> (not graded): Scroll through your functional file. Where does the signal intensity seem to be the highest? Does this surprise you given the contrast that is usually most dominant in fMRI scans? (Tip: it helps if you decrease the "Max." value to around 90,000, set the opacity slider all the way to the right, and it's best visible in the axial view!)
</div><div class='alert alert-warning'>
<b>ToDo</b> (not graded): Try viewing a couple of other volumes (increase/decrease the number next to "Volume"). Visually, you probably won't see much of a difference between different volumes.
</div><div class='alert alert-info'>
    <b>ToThink</b>: Would you expect such small intensity differences between volumes? Why (not)?
</div><p>Instead of manually adjusting the volume number, you can press the “Video” icon (next to the big “+” icon, which you can use to toggle the crosshairs on or off) to start “Movie mode” in which FSLeyes will loop through all volumes. Due to the lag on the server (or a software bug in FSLeyes, I’m not sure), however, FSLeyes is not fast enough to render the volumes, so you’ll likely see a black screen…</p>
<p>That said, looping through your volumes is usually a great way to visually check for artifacts (e.g. spikes) and (extreme) motion in your data! We highly recommend doing this for all your data!</p>
<p>Another useful way to view your fMRI data is using the “Time series” view.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): Open the Timeseries viewer (<tt>View</tt> &rarr; <tt>Time series</tt>). This should split the window in two, with the Timeseries viewer on the bottom. Check out the time series of different voxels.
</div><div class='alert alert-warning'>
<b>ToDo/ToThink</b> (not graded): Go to voxel $[X=23, Y=4, Z=19]$ and look at the time series. Can you deduce what type of experimental design was used in this task? (Hint: the filename kind of gives it away ...)
</div><div class='alert alert-warning'>
<b>ToDo/ToThink</b> (not graded): Go to voxel $[X=26, Y=27, Z=4]$ and look at the time series. Given the location, what do you think the time series of this voxel represents?
</div><p>FSLeyes has many more features than we discussed in this section (e.g., working with standard atlases/parcellations). We’ll demontrate these features throughout the rest of this lab where appropriate!</p>
</div>
<div class="section" id="skullstripping">
<h2>Skullstripping<a class="headerlink" href="#skullstripping" title="Permalink to this heading">#</a></h2>
<p>When viewing the anatomical scan in the previous section, you might have noticed that the scan still contained the subject’s skull. Usually, the skull is removed because it improves registration to the subject’s anatomical T1-scan (especially if you use BBR-based registration). This process is often called “skullstripping” and FSL contains the skullstripping-tool <code class="docutils literal notranslate"><span class="pre">bet</span></code> (which stands for “Brain Extraction Tool”). We’ll demonstrate how to use bet using its command-line interface.</p>
<p>Like all FSL tools with command-line interfaces, you can get more info on how to use it by calling the command with the flag <code class="docutils literal notranslate"><span class="pre">--help</span></code>.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): Call <tt>bet --help</tt> and check out the usage info.
</div><p>You see that the “bet” command should be called as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bet</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">output</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">options</span><span class="o">/</span><span class="n">flags</span><span class="p">]</span>
</pre></div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): Skullstrip the <tt>sub-02_desc-preproc_T1w.nii.gz</tt> file using <tt>bet</tt> and name the output-file <tt>sub-02_desc-preproc+bet_T1w.nii.gz</tt> (don't use any additional flags for now).
</div><p>We recommend visually checking the result of skullstripping for imperfections (e.g. part of the brain that are excluded or parts of non-brain that are included). Let’s do this in FSLeyes!</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded): If there are any active images in FSLeyes at this point, remove them (Overlay &rarr; Remove all). Also, close the Timeseries view (click on the cross in the upper right corner of the timeseries panel).
<p>Then, load the non-skullstripped anatomical file (<tt>sub-02_desc-preproc_T1w.nii.gz</tt>) first. Then, overlay the skullstripped image (the <tt>sub-02_desc-preproc+bet_T1w.nii.gz</tt> file you just created). The difference between the non-skullstripped and the skullstriped image is, now, however not clear; to make this clearer, we can pick a different colormap for the skullstripped brain! For example, change the “Grayscale” colormap to “Red-Yellow”. Also, change the opacity to about 50% to better see the underlying non-skullstripped anatomical scan.</p>
<p>Scroll through the image to see whether <tt>bet</tt> did a good job.</p>
</div><div class='alert alert-warning'>
    <b>ToDo</b> (not graded): In fact, <tt>bet</tt> seemed to have removed some parts of the brain that are actually gray matter tissue (e.g., $[X=97, Y=84, Z=142]$ and $[X=154, Y=187, Z=109]$). 
<p>Also, it failed to remove some non-brain tissue. For example, what non-brain structure do you think is located at <span class="math notranslate nohighlight">\([X=143, Y=178, Z=72]\)</span>? And at <span class="math notranslate nohighlight">\([X=140, Y=124, Z=44]\)</span>?</p>
</div><p>You could, of course, just skullstrip all your participants without looking at the resulting skullstripped brain images. However, as we just saw, this may lead to suboptimal results, which may bias subsequent preprocessing steps, such as functional → anatomical registration and spatial normalization to a standard template. As such, we recommend visually inspecting the skullstrip result for each participant in your dataset!</p>
<p>If you find that <code class="docutils literal notranslate"><span class="pre">bet</span></code> did not do a proper job, you can adjust several parameters to improve the skullstripping operation. The two most useful parameters to adjust are “robust brain centre estimation” (flag <code class="docutils literal notranslate"><span class="pre">-R</span></code>), “fractional intensity threshold” (flag <code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">&lt;value&gt;</span></code>), and the vertical gradient (flag <code class="docutils literal notranslate"><span class="pre">-g</span> <span class="pre">&lt;values&gt;</span></code>). We recommend always enabling “robust brain centre estimation” (which iterates the operation multiple times, which usually gives more robust results).</p>
<p>The proper value for fractional intensity threshold (<code class="docutils literal notranslate"><span class="pre">-f</span></code>) and the vertical gradient (<code class="docutils literal notranslate"><span class="pre">-g</span></code>), however, you need to “tune” yourself (although the default, 0.5, is a good starting value). Smaller values for fractional intensity threshold give you larger brain outline estimates (i.e., “threshold” to be used for image is lower). With the vertical gradient you can tell <code class="docutils literal notranslate"><span class="pre">bet</span></code> to be relatively more “aggressive” (with values &lt; 0) or “lenient” (with values &gt; 0) with removing tissue at the bottom (inferior side) of the brain. So, e.g., using <code class="docutils literal notranslate"><span class="pre">-g</span> <span class="pre">-0.1</span></code> will remove relatively more tissue at the bottom of the brain.</p>
<p>To include these parameters, you can call <code class="docutils literal notranslate"><span class="pre">bet</span></code> with, for example, a “fractional intensity threshold” of 0.4, a vertical gradient of -0.1, and robust brain centre estimation enabled as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bet</span> <span class="o">&lt;</span><span class="nb">input</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">output</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">f</span> <span class="mf">0.4</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="mf">0.1</span> <span class="o">-</span><span class="n">R</span>
</pre></div>
</div>
<div class='alert alert-warning'>
<b>ToDo</b> (1 point)
<p>For this ToDo, try out some different parameters for fractional intensity threshold and vertical gradient, and enable robust brain centre estimation. Note that the output file will be overwritten if you use the same output-name (which is fine if you don’t want to save the previous result). Also, there may not be a combination of settings that creates a “perfect” skullstrip result (at least for this brain).</p>
<p>Once you’re happy with the segmentation, overlay it on the original anatomical file in FSLeyes (and use a different colormap). Then, make a snapshot using the camera icon and save it in your <tt>week_5</tt> directory (name it “my_skullstripped_image.png”). After you created and saved the snapshot, add the following line to the answer-cell below:<br><br></p>
<p><code class="docutils literal notranslate"><span class="pre">![](my_skullstripped_image.png)</span></code><br><br></p>
<p>After adding this to the text-cell below and running the cell, the snapshot should be visible in the notebook.
(This allows us to check whether you actually did the ToDo; there is not necessarily a “correct” answer to this ToDo — we just want you to mess around with <tt>bet</tt> and the command line).</p>
</div><p>YOUR ANSWER HERE</p>
<p>Note that adjusting the parameters of <code class="docutils literal notranslate"><span class="pre">bet</span></code> may in fact not completely solve all the imperfections in the skullstripping procedure. If you <em>really</em> care about accurate segmentation (e.g., when doing anatomical analyses such as <a class="reference external" href="https://en.wikipedia.org/wiki/Voxel-based_morphometry">voxel-based morphometry</a> or <a class="reference external" href="https://www.nudz.cz/files/pdf/skoch_surface_based_morphometry_skoch_eso_konfer_20170629_2.pdf">surface-based analyses</a>), you may consider editing your skullstrip result manually. FSLeyes has an “edit mode” (<em>Tools</em> → <em>Edit mode</em>) in which can manually fill or erase voxels based on your own judgment what is actual brain tissue and what is not.</p>
<p>Skullstripping is actually the only preprocessing operation you <em>have</em> to do manually using the command line (which might be a good idea, anyway, as you should inspect the result manually). The rest of the preprocessing steps within FSL are actually neatly integrated in the FSL tool “FEAT” (FMRI Expert Analysis Tool), which is FSL’s main analysis workhorse (implementing first-level and grouplevel analyses). We’ll discuss doing first-level and fixed-effect analyses with FEAT later in this tutorial, but first let’s talk about the dataset that we’ll use for the upcoming lab!</p>
</div>
<div class="section" id="the-ni-edu-dataset">
<h2>The “NI-edu” dataset<a class="headerlink" href="#the-ni-edu-dataset" title="Permalink to this heading">#</a></h2>
<p>So far in this course, we have used primarily simulated data. From this week onwards, we’ll also use some real data from a dataset (which we’ll call “NI-edu”) acquired at our 3T scanner at the University of Amsterdam. The NI-edu study has been specifically “designed” for this (and the follow-up “pattern analysis”) course. The experimental paradigms used for this dataset are meant to investigate how the brain processes information from faces and the representation of their subjective impressions (e.g., their perceived attractiveness, dominance, and trustworthiness). In addition to tasks that investigate face processing specifically, the dataset also includes several runs with a “functional localizer” task, which can be used to identify regions that preferentially respond to a particular object category (like faces, bodies, characters, etc.). In this course, we’ll mostly use the localizer data, because the associated task (design) is relativelly simple and generates a robust signal.</p>
<p>Below, we download the data needed for this tutorial, which is the anatomical data and functional data from a single run of the flocBLOCKED task (see below) from a single subject (sub-03). The data will be saved in your home directory in a folder named “NI-edu-data”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s1">&#39;NI-edu-data&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data (+- 110MB) will be saved in </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Go get some coffee. This may take a while.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Using the CLI interface of the `awscli` Python package, we&#39;ll download the data</span>
<span class="c1"># Note that we only download the preprocessed data from a single run from a single subject</span>
<span class="c1"># This may take about 2-10 minutes or so (depending on your download speed)</span>

<span class="c1"># Download anatomical files</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;sub-03/ses-1/anat/*&quot;</span>

<span class="c1"># And functional files</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;sub-03/ses-1/func/*task-flocBLOCKED*&quot;</span>

<span class="c1"># And a brain mask (needed for FEAT, later)</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;derivatives/fmriprep/sub-03/ses-1/anat/sub-03_ses-1_acq-AxialNsig2Mm1_desc-brain_mask.nii.gz&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data (+- 110MB) will be saved in /Users/lukas/NI-edu-data ...
Go get some coffee. This may take a while.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
</pre></div>
</div>
</div>
</div>
<p>Anyway, let’s check out the structure of the directory with the data. The <code class="docutils literal notranslate"><span class="pre">niedu</span></code> package has a utility function (in the submodule <code class="docutils literal notranslate"><span class="pre">utils</span></code>) that returns the path to the root of the dataset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The dataset is located here: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">data_dir</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: the dataset could not be found here: </span><span class="si">%s</span><span class="s2"> !&quot;</span> <span class="o">%</span> <span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The dataset is located here: /Users/lukas/NI-edu-data
</pre></div>
</div>
</div>
</div>
<div class="section" id="contents-of-the-dataset">
<h3>Contents of the dataset<a class="headerlink" href="#contents-of-the-dataset" title="Permalink to this heading">#</a></h3>
<p>Throughout the course, we’ll explain the contents of the dataset and use them for exercises and visualizations. For now, it suffices to know that the <em>full</em> dataset contains data from 13 subjects, each scanned twice (i.e., two <em>sessions</em> acquired at different days). Each subject has it’s own sub-directory, which contains an “anat” directory (with anatomical MRI files) and/or a “func” directory (with functional MRI files).</p>
<div class='alert alert-success'>
    <b>Info</b>: The exact number of subjects, tasks, and sessions included in your dataset depends on the version of the dataset you downloaded. The "minimal" version only includes the data absolutely necessary for this course (a single subject), while the "complete" version contains all data (13 subjects; but is substantially larger in size).
</div><p>We can “peek” at the structure/contents of the dataset using the <code class="docutils literal notranslate"><span class="pre">listdir</span></code> function from the built-in <code class="docutils literal notranslate"><span class="pre">os</span></code> package (which stands for “Operating System”):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;derivatives&#39;, &#39;sub-03&#39;]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sub-03</span></code> directory contain the “raw” (i.e., not-preprocessed) data of subject 3. Let’s check out its contents. We’ll do this using a custom function <code class="docutils literal notranslate"><span class="pre">show_tree</span></code> from the <code class="docutils literal notranslate"><span class="pre">niedu</span></code> package:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.global_utils</span> <span class="kn">import</span> <span class="n">show_directory_tree</span>

<span class="c1"># To create the full path, we use the function `os.path.join` instead of just writing out</span>
<span class="c1"># {data_dir}/sub-03. Effectively, `os.path.join` does the same, but takes into account your</span>
<span class="c1"># operating system, which is important because Windows paths are separated by backslashes</span>
<span class="c1"># (e.g., `sub-03\ses-1\anat`) but Mac and Linux paths are separated by forward slashes </span>
<span class="c1"># (e.g., `sub-03/ses-1/anat`).</span>
<span class="n">sub_03_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">)</span>
<span class="n">show_directory_tree</span><span class="p">(</span><span class="n">sub_03_dir</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="s1">&#39;physio&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sub-03/
    ses-1/
        anat/
            sub-03_ses-1_acq-AxialNsig2Mm1_T1w.json
            sub-03_ses-1_acq-AxialNsig2Mm1_T1w.nii.gz
            sub-03_ses-1_acq-AxialNsig2Mm1_T1w_brain.nii.gz
        func/
            sub-03_ses-1_task-face_run-1_events.tsv
            sub-03_ses-1_task-flocBLOCKED_bold.json
            sub-03_ses-1_task-flocBLOCKED_bold.nii.gz
            sub-03_ses-1_task-flocBLOCKED_condition-body_events.txt
            sub-03_ses-1_task-flocBLOCKED_condition-character_events.txt
            sub-03_ses-1_task-flocBLOCKED_condition-face_events.txt
            sub-03_ses-1_task-flocBLOCKED_condition-object_events.txt
            sub-03_ses-1_task-flocBLOCKED_condition-place_events.txt
            sub-03_ses-1_task-flocBLOCKED_condition-response_events.txt
            sub-03_ses-1_task-flocBLOCKED_events.tsv
</pre></div>
</div>
</div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">sub-03</span></code> directory contains a single session directory, “ses-1”. “Sessions” ususally refer to different days that the subject was scanned. Here, we only downloaded data from a single session (while, in fact, there is data from two sessions) in order to limit the amount of data that needed to be downloaded.</p>
<p>Within the <code class="docutils literal notranslate"><span class="pre">ses-1</span></code> directory, there is a <code class="docutils literal notranslate"><span class="pre">func</span></code> directory (with functional MRI files) and an <code class="docutils literal notranslate"><span class="pre">anat</span></code> directory (with anatomical MRI files). These directories contain a bunch of different files, with different file types:</p>
<ul class="simple">
<li><p>(Compressed) nifti files: these are the files with the extension <code class="docutils literal notranslate"><span class="pre">nii.gz</span></code>, which contain the actual MRI data. These are discussed extensively in the next section;</p></li>
<li><p>Json files: these are the files with the extension <code class="docutils literal notranslate"><span class="pre">json</span></code>, which are plain-text files containing important metadata about the MRI-files (such as acquisition parameters). We won’t use these much in this course.</p></li>
<li><p>Event files: these are the files ending in <code class="docutils literal notranslate"><span class="pre">_events.tsv</span></code>, which contain information about the onset/duration of events during the fMRI paradigm.</p></li>
</ul>
<p>This particular organization of the data is in accordance with the “Brain Imaging Data Structure” (BIDS; read more about BIDS <a class="reference external" href="https://bids.neuroimaging.io/">here</a>). If you are going to analyze a new or existing MRI dataset, we strongly suggest to convert it to BIDS first, not only because makes your life a lot easier, but also because there exist many tools geared towards BIDS-formatted datasets (such as <a class="reference external" href="https://fmriprep.readthedocs.io">fmriprep</a> and <a class="reference external" href="https://mriqc.readthedocs.io">mriqc</a>)!</p>
</div>
<div class="section" id="mri-acquisition-parameters">
<h3>MRI acquisition parameters<a class="headerlink" href="#mri-acquisition-parameters" title="Permalink to this heading">#</a></h3>
<p>For each participant, we acquired one T1-weighted, high-resolution (<span class="math notranslate nohighlight">\(1 \times 1 \times 1\)</span> mm.) anatomical scan. Our functional scans were acquired using a (T2*-weighted) gradient-echo echo-planar imaging (GE-EPI) scan sequence with a TR of 700 milleseconds and a TE of 30 milliseconds and a spatial resolution of <span class="math notranslate nohighlight">\(2.7 \times 2.7 \times 2.7\)</span> mm. These functional scans used a “<a class="reference external" href="http://mriquestions.com/simultaneous-slices.html">multiband</a> acceleration factor” of 4 (which is a “simultaneous multislice” technique to acquire data from multiple slices within a single RF pulse, greatly accellerating acquisition time).</p>
</div>
<div class="section" id="experimental-paradigms">
<h3>Experimental paradigms<a class="headerlink" href="#experimental-paradigms" title="Permalink to this heading">#</a></h3>
<p>In this dataset, we used two types of experimental paradigms: a “functional localizer” (which we abbreviate as “floc”) and a simple face perception task (“face”). (We also acquired a resting-state scan, i.e. a scan without an explicit task, but we won’t use that for this course.) The two different floc paradigms (flocBLOCKED and flocER) were each run twice: once in each session. Each session contained 6 face perception runs (so 12 in total).</p>
<div class="section" id="functional-localizer-task">
<h4>Functional localizer task<a class="headerlink" href="#functional-localizer-task" title="Permalink to this heading">#</a></h4>
<p>The functional localizer paradigm we used was developed by the <a class="reference external" href="http://vpnl.stanford.edu/fLoc/">Stanford Vision &amp; Perception Neuroscience Lab</a>. Their stimulus set contains images from different categories:</p>
<ul class="simple">
<li><p>characters (random strings of letters and numbers);</p></li>
<li><p>bodies (full bodies without head and close-ups of limbs);</p></li>
<li><p>faces (adults and children);</p></li>
<li><p>places (hallways and houses);</p></li>
<li><p>objects (musical instruments and cars).</p></li>
</ul>
<p>These categories were chosen to target different known, (arguably) category-selective regions in the brain, including the occipital face area (OFA) and fusiform face area (FFA; face-selective), parahippocampal place area (PPA; place/scene selective), visual word form area (VWFA; character-selective) and extrastriate body area (EBA; body-selective).</p>
<p>In the functional localizer task, participants had to do a <a class="reference external" href="https://en.wikipedia.org/wiki/N-back">“one-back” task</a>, in which they had to press a button with their <em>right</em> hand when they saw exactly the same image twice in a row (which was about 10% of the trials).</p>
<p>Importantly, we acquired this localizer in two variants: one with a blocked design (“flocBLOCKED”) and one with an event-related design (“flocER”; with ISIs from an exponential distribution with a 2 second minimum). The blocked version presented stimuli for 400 ms. with a fixed 100 ms. inter-stimulus interval in blocks of 12 stimuli (i.e., 6 seconds). Each run started and ended with a 6 second “null-blocks” (a “block” without stimuli) and additionally contained six randomly inserted null-blocks. The event-related version showed each stimulus for 400 ms. as well, but contained inter-stimulus intervals ranging from 2 to 8 seconds and no null-blocks apart from a null-block at the start and end of each run (see figure below for a visual representation of the paradigms).</p>
<p><img alt="floc_paradigm" src="https://docs.google.com/drawings/d/e/2PACX-1vStNqan0MgQluLbUh_R6C0R96juxmLE_K_MJLWEisHJaqcsT0AmffdpoU6HEXSLRdHQhOxW1NM8WUd8/pub?w=1102&amp;h=646" /></p>
<p>These two different versions (blocked vs. event-related) were acquired to demonstrate the difference in detection and estimation efficiency of the two designs. In this course, we only use the <em>blocked</em> version.</p>
</div>
<div class="section" id="face-perception-task">
<h4>Face perception task<a class="headerlink" href="#face-perception-task" title="Permalink to this heading">#</a></h4>
<p>In the face perception task, participants were presented with images of faces (from the publicly available <a class="reference external" href="https://figshare.com/articles/Face_Research_Lab_London_Set/5047666">Face Research Lab London Set</a>). In total, frontal face images from 40 different people (“identities”) were used, which were either without expression (“neutral”) or were smiling. Each face image (from in total 80 faces, i.e., 40 identities <span class="math notranslate nohighlight">\(\times\)</span> 2, neutral/smiling) was shown, per participant, 6 times across the 12 runs (3 times per session). We won’t discuss the data from this task, as it won’t be used in this course.</p>
</div>
</div>
</div>
<div class="section" id="using-fsl-feat-for-preprocessing-and-first-level-analysis">
<h2>Using FSL FEAT for preprocessing and first-level analysis<a class="headerlink" href="#using-fsl-feat-for-preprocessing-and-first-level-analysis" title="Permalink to this heading">#</a></h2>
<p>Most univariate fMRI studies contain data from a sample of multiple individuals. Often, the goal of these studies is to (1) <em>estimate</em> some effect (e.g., <span class="math notranslate nohighlight">\(\beta_{face} &gt;0\)</span>) at the group-level, i.e., whether the effect is present within our sample, and subsequently, taking into account the variance (uncertainty) of this group-level effect, (2) to <em>infer</em> whether this effect is likely to be true in the broader population (but beware of the tricky interpretation of <a class="reference external" href="https://en.wikipedia.org/wiki/Statistical_hypothesis_testing#Criticism">null-hypothesis significance tests</a>).</p>
<div class="section" id="a-primer-on-the-summary-statistics-approach">
<h3>A primer on the “summary statistics” approach<a class="headerlink" href="#a-primer-on-the-summary-statistics-approach" title="Permalink to this heading">#</a></h3>
<p>When you have fMRI data from multiple participants, you are dealing with inherently <em>hierarchical</em> (sometimes called “multilevel”, “mixed”, or simply “nested”) data: you have data from multiple participants, which may be split across different runs or sessions, which each contain multiple observations (i.e., volumes across time).</p>
<p>Often, people use so called “mixed models” (or “multilevel models”) to deal with this kind of hierarchical data. These type of models use the GLM framework for estimating effects, but have a special way of estimating the variance of effects (i.e., <span class="math notranslate nohighlight">\(\mathrm{var}[c\hat{\beta}]\)</span>), which includes variance estimates from all levels within the model (subject-level, run-level, and group-level). In these mixed models, you can simply put all your data (<span class="math notranslate nohighlight">\(y\)</span> and <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>) from different runs, sessions, and subjects, in a single GLM and estimate the effects of interest (and their variance).</p>
<p>Unfortunately, this “traditional” multilevel approach is not feasible for most univariate (whole-brain) analyses, because these models are quite computationally expensive (i.e., they take a long time to run), so doing this for all &gt; 200,000 voxels is the brain is not very practical. Fortunately, the fMRI community came up with a solution: the “summary statistics” approach, which approximates a proper full multilevel model.</p>
<p>This summary statistics approach entails splitting up the analysis of (hierarchical) fMRI data into different steps:</p>
<ul class="simple">
<li><p>Analysis at the single-subject (time series) level</p></li>
<li><p>Analysis at the run level (optional; only if you have &gt;1 run!)</p></li>
<li><p>Analysis at the group level</p></li>
</ul>
<p>The GLM analyses you did in week 2-4 were examples of “first-level” analyses, because they analyzed the time series of voxels from a single subject. This is the first step in the summary statistics approach. In this section, we’re going to demonstrate how to implement first-level analyses (and preprocessing) using FSL FEAT.</p>
<p>Later in this lab, we’re going to demonstrate how to implement analyses at the run-level. Next week, we’ll discuss group-level models. For now, let’s focus on how to run first-level analyses in FSL using FEAT.</p>
</div>
<div class="section" id="first-level-analyses-and-preprocessing-in-feat">
<h3>First-level analyses (and preprocessing) in FEAT<a class="headerlink" href="#first-level-analyses-and-preprocessing-in-feat" title="Permalink to this heading">#</a></h3>
<p>Alright, let’s get started with FEAT. You can start the FEAT graphical interface by typing <code class="docutils literal notranslate"><span class="pre">Feat</span> <span class="pre">&amp;</span></code> in the command line (the <code class="docutils literal notranslate"> <span class="pre">&amp;</span></code> will open FEAT in the background, so you can keep using your command line).*</p>
<hr class="docutils" />
<p>* Note that the upcoming ToDos do not have test-cells; at the very end of this section, you’ll save your FEAT setup, which we’ll test (with only hidden tests) afterwards.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): Open FEAT (<tt>Feat &</tt>). Make sure you are in your home folder (which you can navigate to by typing <tt>cd</tt>) when you do.
</div><div class="section" id="the-data-tab">
<h4>The “Data” tab<a class="headerlink" href="#the-data-tab" title="Permalink to this heading">#</a></h4>
<p>After calling <code class="docutils literal notranslate"><span class="pre">Feat</span> <span class="pre">&amp;</span></code> in the command line, the FEAT GUI should pop up. This GUI has several “tabs”, of which the “Data” tab is displayed when opening FEAT. Below, we summarized the most important features of the “Data” tab.</p>
<p><img alt="FEAT_GUI" src="https://docs.google.com/drawings/d/e/2PACX-1vShulkW5g4cAZ_hny-jJneA8WH6rFHwOinXt4TbXJl2zmWMpb44XqBd0txy6HVXIJCVCLv2G3rdwOEs/pub?w=1068&amp;h=839" /></p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): In this section, we'll analyze a single run of the <tt>flocBLOCKED</tt> paradigm of a single participant (<tt>sub-03</tt>). The data from this participant is located in the following directory (not in your public directory jupyter-nim_XX/Public/):
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">sub_03_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/lukas/NI-edu-data/sub-03
</pre></div>
</div>
</div>
</div>
<p>We are going to analyze the <code class="docutils literal notranslate"><span class="pre">flocBLOCKED</span></code> data from the first session (<code class="docutils literal notranslate"><span class="pre">ses-1</span></code>): <code class="docutils literal notranslate"><span class="pre">sub-03/ses-1/sub-03_ses-1_task-flocBLOCKED_bold.nii.gz</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub_03_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_03_dir</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_task-flocBLOCKED_bold.nii.gz&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We are going to analyse: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">sub_03_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>We are going to analyse: /Users/lukas/NI-edu-data/sub-03/ses-1/func/sub-03_ses-1_task-flocBLOCKED_bold.nii.gz
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
<b>ToDo</b> (0.5 points)
<p>Let’s fill in the Data tab in FEAT. Click on “Select 4D data”, click on the “folder” icon, and navigate to the file (<tt>sub-03_ses-1_task-flocBLOCKED_bold.nii.gz</tt>). Once you’ve selected the file, click on “OK”.  Note: within FEAT, you can click on <tt>..</tt> to go “up” one folder. This way, you can “navigate” to the location of the file that you want to add.</p>
<p>Then, set the output directory to your home folder + <tt>sub-03_ses-1_task-flockBLOCKED</tt>. Note: this directory doesn’t exist yet! By setting the output directory to this directory, you’re telling FSL to <em>create</em> a directory here in which the results will be stored.</p>
<p>After selecting the 4D data, the “Total volumes” and “TR” fields should update to 325 and 0.700000, respectively. You can leave the “Delete volumes” field (0) and high-pass filter (100) as it is (no need to remove volumes and 100 second high-pass is a reasonable default).</p>
</div></div>
<div class="section" id="the-pre-stats-tab">
<h4>The “Pre-stats” tab<a class="headerlink" href="#the-pre-stats-tab" title="Permalink to this heading">#</a></h4>
<p>Now, let’s check out the “pre-stats” tab, which contains most of the preprocessing settings. Most settings are self-explanatory, but if you want to know more about the different options, hover you cursor above the option (the text, not the yellow box) for a couple of seconds and a green window will pop up with more information about that setting!</p>
<p>Note that the checkbox being yellow means that the option has been selected (and a gray box means it is not selected).</p>
<p>Ignore the “Alternative reference image”, “B0 unwarping”, “Intensity normalization”, “Perfusion subtraction”, and “ICA exploration” settings; these are beyond the scope of this course!</p>
<div class='alert alert-warning'>
<b>ToDo</b> (0.5 points)
<p>Let’s fill in the Pre-stats tab! Select the following:<br></p>
<ol class="arabic simple">
<li><p>Select “MCFLIRT” for motion-correction (this is the name of FSL’s motion-correction function);<br></p></li>
<li><p>Set “Slice timing correction” to “None” (we believe that slice-time correction does more harm than good for fMRI data with short TRs, like ours, but “your mileage may vary”);<br></p></li>
<li><p>Turn on “BET brain extraction” (this refers to skullstripping of the <i>functional</i> file! This can be done automatically, because it’s less error-prone than skullstripping of anatomical images);<br></p></li>
<li><p>Set the FWHM of the spatial smoothing to 4 mm;<br></p></li>
<li><p>Turn off “intensity normalization” (you should never use this for task-based fMRI analysis);<br></p></li>
<li><p>Turn on “highpass filtering”; leave “perfusion subtraction” unchecked;<br></p></li>
<li><p>Leave “ICA exploration” unchecked</p></li>
</ol>
</div></div>
<div class="section" id="the-registration-tab">
<h4>The “Registration” tab<a class="headerlink" href="#the-registration-tab" title="Permalink to this heading">#</a></h4>
<p>Alright, let’s check out the “Registration” tab, in which you can setup the co-registration plan (from the functional data to the T1-weighted anatomical scan, and from the T1-weighted anatomical scan to standard space; we usually don’t have an “expanded functional image”, so you can ignore that).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (0 points): Enable the "Main structural image" option. You should see an empty field (where you need to fill in the path to the skullstripped structural file) and below it a "search" option and the particular registration method. We'll leave it to "Normal search" and BBR ("Boundary-Based Registration", a particular functional-to-T1 registration technique).
</div><p>Now, for the “Main structural image”, you actually need a high-resolution T1-weighted anatomical file that has already been skullstripped. You could do that with, for example, <code class="docutils literal notranslate"><span class="pre">bet</span></code> for this particular partipant. Below, we do this slightly differently, by applying an existing mask, computed by <a class="reference external" href="https://fmriprep.readthedocs.io/">Fmriprep</a>, to our structural image. We use the Python package <a class="reference external" href="https://nilearn.github.io/">Nilearn</a> for this (you will learn more about this package in week 7)! No need to fully understand the code below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">masking</span><span class="p">,</span> <span class="n">image</span>

<span class="c1"># Define anatomical file ...</span>
<span class="n">anat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_03_dir</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_acq-AxialNsig2Mm1_T1w.nii.gz&#39;</span><span class="p">)</span>

<span class="c1"># ... and mask</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fmriprep&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_acq-AxialNsig2Mm1_desc-brain_mask.nii.gz&#39;</span><span class="p">)</span>

<span class="c1"># Affine of mask is different than original anatomical file (?),</span>
<span class="c1"># so let&#39;s resample the mask to the image</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resample_to_img</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">anat</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

<span class="c1"># Set everything outside the mask to 0 using the apply_mask/unmask trick</span>
<span class="n">anat_sks</span> <span class="o">=</span> <span class="n">masking</span><span class="o">.</span><span class="n">unmask</span><span class="p">(</span><span class="n">masking</span><span class="o">.</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">anat</span><span class="p">,</span> <span class="n">mask</span><span class="p">),</span> <span class="n">mask</span><span class="p">)</span>

<span class="c1"># And finally save the skullstripped image in the same directory as the</span>
<span class="c1"># original anatomical file</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">anat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;_brain.nii.gz&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out</span><span class="p">):</span>
    <span class="n">anat_sks</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (0.5 points): Select the skullstripped file of <tt>sub-03</tt> (the one ending in <tt>_brain.nii.gz</tt> in the anatomy subfolder) for the "Main structural image". In fact, FSL also needs the original (non-skullstripped) T1-file, but it will assume that the original file is in the same directory and has the same name, but without the <tt>_brain</tt> suffix (which is the case for our file).
<p>You can leave the file under “Standard space” as it is (this is the MNI152 2mm template, one of the most used templates in the fMRI research community). Turn on the “Nonlinear” option in the “Standard space” box and do not change the default options of non-linear registration.</p>
</div></div>
<div class="section" id="the-stats-tab">
<h4>The “Stats” tab<a class="headerlink" href="#the-stats-tab" title="Permalink to this heading">#</a></h4>
<p>Almost there! Up next is the “Stats” tab, in which you specify the design (<span class="math notranslate nohighlight">\(\mathbf{X}\)</span>) you want to use to model the data.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (0.5 points): First, make sure "FILM prewhitening" is turned on ("FILM" is just the name of FSL's prewhitening implementation). Then, select "Standard Motion Parameters" in the box below, which instructs FEAT to use the six motion parameters as nuisance predictors in the design. You don't have to do anything with the "Voxelwise Confound List" and "Add additional confound EVs" options.
</div><p>Then, to specify our predictors-of-interest, we need to click the “Full model setup” button. This creates a new window in which we can create our predictors; see the image below for an explanation of the options.</p>
<p><img alt="" src="https://docs.google.com/drawings/d/e/2PACX-1vQx4QOsd6ubSO2ATH6z3jinbhGsi-o62yauOCTV0sanMEzbLf9BszlX6AGzGM3D3Z-fYF3V6WXexf3l/pub?w=973&amp;h=727" /></p>
<p>The most often-used option to define the event onsets and durations is the “Custom (3 column format)” option. This allows you to select a standard text-file with three columns (separated by tabs), in which the first column indicates the event onsets (in seconds), the second column indicates the event duration (in seconds), and the third column indicates the event “weight” (which may vary in case of parametric designs; for non-parametric designs, you should set the weight-value to 1). Different rows define different events of a particular condition.</p>
<p>Our data only has a BIDS-compatible “events” file, which contain the onset, duration, and trial type of trials from all conditions, while FSL requires a separate events file <em>per condition</em> (and without a header). Below, we run a function that creates these separate condition files for us:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.utils.nii</span> <span class="kn">import</span> <span class="n">create_fsl_onset_files</span>
<span class="n">create_fsl_onset_files</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
<b>ToDo</b> (1 point):
<p>Let’s set up the design! For our <tt>flocBLOCKED</tt> run, we should model each of the image conditions (“face”, “body”, “place”, “character”, and “object”) as separate predictors, assuming that they have a different effect on voxels (in different brain regions). Let’s model the responses (button presses) as well.</p>
<p>So, create six predictors with the names “face”, “body”, “place”, “character”, “object”, and “response” (in this <em>exact</em> order). To save you some work, we have already created the onset-files associated with these six different conditions (which end in: <tt>*condition-{name of condition}_events.txt</tt>).</p>
<p>For each predictor:</p>
<ul class="simple">
<li><p>set the convolution to “Double-Gamma HRF”</p></li>
<li><p><strong>turn off the “Add temporal derivative”</strong> and “Orthogonalise” options</p></li>
<li><p>leave the “Apply temporal filtering” option checked (this applies the high-pass filter to the design, <span class="math notranslate nohighlight">\(X\)</span>, as well).</p></li>
</ul>
</div><div class='alert alert-info'>
    <b>ToThink</b> (1 point): Here, we chose not to include temporal derivatives, because we believe that, given the experimental design, including them is unlikely to lead to a better model fit. Why do you think this might be the case?
</div><p>YOUR ANSWER HERE</p>
<p>If you did it correctly, you can press the “View design” button and a new window with the design should pop up (with the different predictors as squiggly lines from top top bottom). The red line of the left side of the design matrix represents the (length of the) high-pass filter.</p>
<div class='alert alert-info'>
    <b>ToThink</b> (1 point): If you look closely at the predictors (columns) of the visualized design matrix, you'll notice that the first and last couple of time points are not "straight" (i.e., at zero) but are slightly increasing or decreasing. What causes this effect? (Hint: the answer can be found in the 'temporal preprocessing' tutorial!)
</div><p>YOUR ANSWER HERE</p>
<p>Now let’s create some contrasts! In the “Contrasts and F-tests” tab, you can specify the contrasts that you want to test. Importantly, FSL makes a difference between “Original EVs” and “Real EVs”. Original EVs are the predictors-of-interest that you defined in the “EVs” tab. Real EVs are the original EVs + the extra predictors that are generated due to the specific HRF-model. For example, if you’d choose a gamma basis set instead of a double-gamma HRF, the original canonical HRF of each predictor would be “Original EVs” while <em>all</em> predictors making up the HRF-components (canonical and temporal and dispersion derivatives) would be the “Real EVs”. In our case, the original and real EVs are the same.</p>
<p>To create contrasts (and F-tests, i.e., collections of contrasts), click on the “Contrasts &amp; F-tests” tab. Here, you define the actual contrast vectors. For each contrast, you can give it a name (under “Title”) and set the contrast weight for each predictor (or “EV”). To create F-tests, set the number of F-tests that you want to do (i.e., increase the number next to the “F-tests” field), and check, per F-test, which contrasts to want to include in them. For example, if you want to include contrasts 1 and 2 in F-test, make sure that these checkboxes are selected under “F1” (or “F2”, “F3”, etc.).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (4 points, 0.5 per contrast/F-test)
<p>Given the six original EVs (“face”, “body”, “place”, “character”, “object”, and “response”), define the contrasts corresponding to the following null (<span class="math notranslate nohighlight">\(H_{0}\)</span>) and alternative (<span class="math notranslate nohighlight">\(H_{a}\)</span>) hypotheses (give them whatever name you want, but adhere to this order):<br></p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{face} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: \beta_{face} &gt; 0\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{place} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: \beta_{place} &gt; 0\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{response} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: \beta_{response} &gt; 0\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: 4\times\beta_{face} - \beta_{body} - \beta_{place} - \beta_{character} - \beta_{object} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: 4\times\beta_{face} - \beta_{body} - \beta_{place} - \beta_{character} - \beta_{object} &gt; 0\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: 4\times\beta_{place} - \beta_{body} - \beta_{face} - \beta_{character} - \beta_{object} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: 4\times\beta_{place} - \beta_{body} - \beta_{face} - \beta_{character} - \beta_{object} &gt; 0\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{face} = \beta_{body} = \beta_{place} = \beta_{character} = \beta_{object} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: (\beta_{face} &gt; 0)\ \&amp;\ (\beta_{body} &gt; 0)\ \&amp;\ (\beta_{place} &gt; 0)\ \&amp;\ (\beta_{character} &gt; 0)\ \&amp;\ (\beta_{object} &gt; 0)\)</span><br><br></p></li>
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{face} = \beta_{body} = \beta_{place} = \beta_{character} = \beta_{object} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: (\beta_{face} &lt; 0)\ \&amp;\ (\beta_{body} &lt; 0)\ \&amp;\ (\beta_{place} &lt; 0)\ \&amp;\ (\beta_{character} &lt; 0)\ \&amp;\ (\beta_{object} &lt; 0)\)</span></p></li>
</ol>
<p>Also, define the following F-test (where the vertical line stands for “or”):</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(H_{0}: \beta_{face} = \beta_{place} = 0\)</span><br><span class="math notranslate nohighlight">\(H_{a}: (\beta_{face} \neq 0)\ |\ (\beta_{place} \neq 0)\)</span></p></li>
</ol>
</div><p>After you’re done defining the contrasts and F-test, you can press “View design” again, which will now also include the contrasts/F-tests that you defined. Moreover, if you click on “Efficiency”, a new window opens with information about the effiency of the design. On the left, a correlation matrix of the predictors is shown, where darker off-diagonal cells means lower correlation between predictors (which is a good thing!). On the right, the diagonal of the matrix shows you the “eigenvalues” of the singular value decomposition of the design matrix, which should decrease from top-left to bottom-right. In general, the brighter the values, the more efficient the design matrix. In the lower-right corner, it lists the estimated effect size (as % signal change) required for a significant effect. These estimates depend on your design efficiency (<span class="math notranslate nohighlight">\(\mathbf{c}(\mathbf{X}^{T}\mathbf{X})^{-1}\mathbf{c}^{T}\)</span>) and the assumed level of noise (<span class="math notranslate nohighlight">\(\hat{\sigma}^2\)</span>): the lower these values, the better!</p>
<div class='alert alert-warning'>
<b>ToDo</b> (ungraded): click "Done". If you implemented the contrasts/F-test correctly, you shouldn't see error messages, and you'll see the design matrix pop up again. 
</div></div>
<div class="section" id="the-post-stats-tab">
<h4>The “Post-stats” tab<a class="headerlink" href="#the-post-stats-tab" title="Permalink to this heading">#</a></h4>
<p>Alright, the last tab! The “Post-stats” tab contains options to threshold the resulting statistics-maps. The only interesting options for our purposes are those in the “Thresholding” box. Technically, we don’t need to threshold any of our statistics, because we are only interested in inference at the group-level (not the first-level analysis; we’re not aiming to infer anything from the results of a single-subject!). But using a p-value threshold of 0.05 “uncorrected” (which means: not corrected for multiple comparisons — a topic we’ll discuss next week!) is usually used to detect any potential problems during the experimental, preprocessing, and analysis process. For example, if we don’t see significant visual cortex activation in response to a task with visual stimuli at <span class="math notranslate nohighlight">\(p &lt; 0.05\)</span> (uncorrected), then it is very likely that something went wrong somewhere in the preprocessing/analysis pipeline (e.g., stimulus onsets are incorrect).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (0.5 points): Set the thresholding type to "Uncorrected" and the p-value to 0.005 (not the default 0.05).
</div><p>Alright, we’re done setting up FEAT for our first-level analysis! One last thing: let’s save the setup (which we’ll check and grade).</p>
<div class='alert alert-warning'>
<b>ToDo</b> (not graded, but necessary to grade the other things): Click the "Save" button in FEAT's main menu and save the setup in your <tt>week_5</tt> directory with the name <tt>setup_feat.fsf</tt>.
</div><p>We actually ran the first-level analysis for this participant already, so you don’t have to do this yourself! We’ll check it out in the next section. (The following cells all test your <code class="docutils literal notranslate"><span class="pre">setup_feat.fsf</span></code> file; as they all have hidden test, you may ignore them.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your setup_feat.fsf file: initial check + Data tab&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="n">par_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
<span class="k">if</span> <span class="n">par_dir</span> <span class="o">!=</span> <span class="s1">&#39;solutions&#39;</span><span class="p">:</span>  <span class="c1"># must be a student-account</span>
    <span class="n">fsf</span> <span class="o">=</span> <span class="s1">&#39;setup_feat.fsf&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fsf</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find a &#39;setup_feat.fsf&#39; file in your week_5 directory!&quot;</span><span class="p">)</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">/var/folders/0c/2qv1yrms7f56lxzzw28nt_440000gn/T/ipykernel_32724/4285188295.py</span> in <span class="ni">&lt;cell line: 6&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">fsf</span> <span class="o">=</span> <span class="s1">&#39;setup_feat.fsf&#39;</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fsf</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">9</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t find a &#39;setup_feat.fsf&#39; file in your week_5 directory!&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> 
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>

<span class="ne">ValueError</span>: Couldn&#39;t find a &#39;setup_feat.fsf&#39; file in your week_5 directory!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your setup_feat.fsf file: Pre-stats tab&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your setup_feat.fsf file: Registration tab&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your setup_feat.fsf file: Stats tab (filt) &#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your setup_feat.fsf file: Stats tab (EVs) &#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 1)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 2)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 3)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 4)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 5)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 6)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab, (con 7)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Stats tab (F-test)&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests your feat_setup.fsf file: Post-stats tab&#39;&#39;&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Only hidden tests!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Only hidden tests!
</pre></div>
</div>
</div>
</div>
<div class='alert alert-danger'>
    <b>Note</b>: No need to actually run this first-level analysis &mdash; we did it already for you!
</div></div>
</div>
</div>
<div class="section" id="making-sense-of-feat-output">
<h2>Making sense of FEAT output<a class="headerlink" href="#making-sense-of-feat-output" title="Permalink to this heading">#</a></h2>
<p>When FEAT is running the analyis, it will create a results-directory (at the location you specified) ending in <code class="docutils literal notranslate"><span class="pre">.feat</span></code>, which contains all the information and files necessary for the analysis as well as the results. Fortunately, it also generates an informative <code class="docutils literal notranslate"><span class="pre">report.html</span></code> file with a nice summary of the preprocessing and analysis results. We already ran a first-level analysis like with the setup that you specified in the previous section, which we download below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting download of FEAT directory (+- 285MB) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;derivatives/fsl/sub-03/flocBLOCKED/ses-1.feat/*&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Starting download of FEAT directory (+- 285MB) ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
</pre></div>
</div>
</div>
</div>
<p>The downloaded data is located here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feat_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fsl&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;flocBLOCKED&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-1.feat&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feat_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/lukas/NI-edu-data/derivatives/fsl/sub-03/flocBLOCKED/ses-1.feat
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Navigate to the FEAT directory using the command line (with <tt>cd</tt>!) and, once you're in the right directory, open the <tt>report.html</tt> file with:
<p><tt>firefox report.html</tt></p>
</div><div class="section" id="checking-the-report-html-file">
<h3>Checking the report.html file<a class="headerlink" href="#checking-the-report-html-file" title="Permalink to this heading">#</a></h3>
<p>The “Registration” tab shows you several figures related to the (two-step) co-registration process.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (ungraded): Check out the Registration tab.
</div><p>In each figure, the red outline shows the <em>target</em> (i.e., where the data is registered to). Each figure contains two subplots, which show the co-registration in different “directions”. The reason they plot both “directions” is that a single “direction” may give you a little information about whether the registration completed without problems.</p>
<p>The first image shows you the result from the complete registration process: from our functional file (“FMRI”) to the MNI152 template (“standard space”). Here, the <em>target</em> (in red) is the outline of the MNI152 template. The other figures show the intermediate results in the two-step co-registration process. The second figure (“Registration of example_func to highres”) shows you first registration step: the BBR-based registration of (a reference volume of) our functional data to the high-resolution T1-weighted scan. Note that, in the upper row, the red outline represents the <em>white matter boundaries</em> of our T1-weighted scan, because this is wat BBR uses as the registration target (rather than the entire volume).</p>
<p>The third image show you the second registration step: the affine + non-linear registration of our high-resolution T1-weighted scan to the MNI152 template. The fourth image shows you the result of the entire two-step registration procedure (functional → template; essentially the same as the first image).</p>
<div class='alert alert-info'>
    <b>ToThink</b> (ungraded): We didn't use distortion correction in this particular preprocessin/analysis pipeline. From the images within the Registration page, where in the brain does geometric distortion cause the most severe registration inaccuracies? (Hint: it's best visible in the first image.)
</div><div class='alert alert-warning'>
<b>ToDo/ToThink</b> (ungraded): Now check out the Pre-stats tab. This primarily shows you the estimated motion parameters (translations, rotations) from this run. Can you deduce from the translation/rotation plots which volume was chosen as the reference volume for motion correction?
</div><div class='alert alert-warning'>
<b>ToDo</b> (ungraded): Check out the Stats tab. Notice that the 6 motion parameters (indicated by the name <tt>conf</tt>, for 'confounding' variables) were added to the design by FEAT. (Also, we cut off the part of the design figure with the contrast definitions &mdash; otherwise the previous ToDos would be a bit too easy.)
</div><div class='alert alert-warning'>
<b>ToDo</b> (not graded): Check out the Post-stats tab. This shows you the results of the different contrasts (and F-tests) by plotting back the parameter estimates (here: "zstats", which are just t-values converted to z-values), which are thresholded at $p < 0.005$ (uncorrected for multiple comparisons), on the brain.
</div><p>This overview is an excellent way to check whether the results are roughly what you’d expect. For example, you’d expect to see clear activation in visual cortex for our the contrasts against baseline (zstat1: face &gt; 0 and zstat2: place &gt; 0 and zstat6: stim).</p>
<p>Apart from the z-statistic maps, FSL shows you for each contrast the time series of the voxel that has the highest z-value. The plots show the data (i.e., <span class="math notranslate nohighlight">\(y\)</span>; in red), the model-fit (i.e., <span class="math notranslate nohighlight">\(\hat{y}\)</span>; in blue/purple), and the “partial model fit” from that contrast (i.e., <span class="math notranslate nohighlight">\(X_{c}\hat{\beta}_{c}\)</span> for that particular contrast <span class="math notranslate nohighlight">\(c\)</span>; in green).</p>
</div>
<div class="section" id="checking-out-the-results-from-feat-in-fsleyes">
<h3>Checking out the results from FEAT (in FSLeyes)<a class="headerlink" href="#checking-out-the-results-from-feat-in-fsleyes" title="Permalink to this heading">#</a></h3>
<p>While the <code class="docutils literal notranslate"><span class="pre">report.html</span></code> file provides a nice summary of the results, it’s also good to visualize and look at output of FEAT is more detail. First, we’ll walk you through the contents of the FEAT directory and then we’ll take a look at the results in FSLeyes.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Open (a new tab in) a terminal and navigate to the FEAT directory. Then, inspect the contents using <tt>ls</tt>.
</div><p>You should see a large set of different files: text-files, nifti-files, and subdirectories. Many of these files represent intermediary output from FEAT or data/images necessary for the <code class="docutils literal notranslate"><span class="pre">report*.html</span></code> files (which we inspected earlier). The most important subdirectories are the <code class="docutils literal notranslate"><span class="pre">reg</span></code> and <code class="docutils literal notranslate"><span class="pre">stats</span></code> directories. These contain the registration parameters and GLM results, respectively, that we later need for our fixed-effects and group-level analyses.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Navigate to the <tt>reg</tt> directory and list its contents (using <tt>ls</tt>).
</div><p>The <code class="docutils literal notranslate"><span class="pre">.mat</span></code> files contain affine matrices for the different registration steps: from functional to the high-resolution anatomical scan (<code class="docutils literal notranslate"><span class="pre">example_func2highres.mat</span></code>) and from the high-resolution anatomical scan to the standard template (<code class="docutils literal notranslate"><span class="pre">highres2standard.mat</span></code>) (and the inverse matrices: <code class="docutils literal notranslate"><span class="pre">highres2example_func.mat</span></code> and <code class="docutils literal notranslate"><span class="pre">standard2example_func.mat</span></code>). In addition, it contains the “warpfield” (files ending in <code class="docutils literal notranslate"><span class="pre">_warp.nii.gz</span></code>) computed by the non-linear registration step, i.e., how much each voxel needs to be moved in each direction (<span class="math notranslate nohighlight">\(X, Y, Z\)</span>).</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Print the contents of the <tt>example_func2highres.mat</tt> file to the terminal using <tt>cat</tt>. Does it look like what you expected?
</div><div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Navigate into the <tt>stats</tt> folder (do you remember how to go "up" one directory?) and check the contents (with <tt>ls</tt>).
</div><p>Basically, all the nifti files you see here are 3D files (“brain maps”), representing different parts of the <em>t</em>-value formula, as is visualized in the figure below:</p>
<p><img alt="" src="https://docs.google.com/drawings/d/e/2PACX-1vR-5iD5TFrr194SXice4QphFxWM-F7CIFzVn7BymYcE9jL5E0XzPW2-ZE2TInyDZU9Ri-NaSsnFvx2_/pub?w=1246&amp;h=586" /></p>
<p>In fact, to show you that the these files are simply parts of the <span class="math notranslate nohighlight">\(t\)</span>-value formula, let’s calculate a <em>t</em>-stat map ourselves using the <code class="docutils literal notranslate"><span class="pre">cope</span></code> and <code class="docutils literal notranslate"><span class="pre">varcope</span></code> files.</p>
<div class='alert alert-danger'>
<b>Assignment</b> (2 points):
<p>Below, we load the <tt>cope1.nii.gz</tt> (containing the <span class="math notranslate nohighlight">\(\mathbf{c}\hat{\beta}\)</span> values per voxel for contrast 1) and <tt>varcope1.nii.gz</tt> (containing the <span class="math notranslate nohighlight">\(\hat{\sigma}^{2}\mathbf{c}(\mathbf{X}^{T}\mathbf{V}^{-1}\mathbf{X})^{-1}\mathbf{c}^{T}\)</span> values per voxel for contrast 1). Calculate the corresponding 3D tstat map (containing all t-values per voxel for contrast 1) <em>using numpy array operations</em>, so no for loop! Store this in a variable named <tt>tstat1</tt>.</p>
<p>Hint: all voxels outside the brain (in both the <tt>cope1.nii.gz</tt> and the <tt>varcope.nii.gz</tt> files) will have the value 0. When calculating the t-values, this will lead to <tt>nan</tt> values (“not a number) because you’re dividing 0 by 0 (which will give a <tt>RuntimeWarning</tt>). Make sure set these <tt>nan</tt> values back to 0 (the function <tt>np.isnan</tt> might be useful ….).</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Implement your ToDo here!</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">cope1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feat_dir</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="s1">&#39;cope1.nii.gz&#39;</span><span class="p">)</span>
<span class="n">cope1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cope1_path</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
<span class="n">varcope1_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feat_dir</span><span class="p">,</span> <span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="s1">&#39;varcope1.nii.gz&#39;</span><span class="p">)</span>
<span class="n">varcope1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">varcope1_path</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="c1"># Some (visible) tests to check minor mistakes</span>
<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">tstat1</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are still nans in your data!&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">niedu.tests.nii.week_5</span> <span class="kn">import</span> <span class="n">test_tvalue_from_fsl</span>
<span class="n">test_tvalue_from_fsl</span><span class="p">(</span><span class="n">tstat1</span><span class="p">,</span> <span class="n">feat_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Alright, now let’s continue with the more interesting part: visualizing the results.</p>
<div class='alert alert-warning'>
<b>ToDo</b> (ungraded): If there are any active overlays, close them (Overlay &rarr; Remove all). Then, open the entire FEAT directory by clicking: File &rarr; Add from directory &rarr; navigate to the FEAT directory and click "Open". Note that you can use the "backspace" key to go up one directory.
</div><p>FSLeyes will automatically open the <code class="docutils literal notranslate"><span class="pre">filtered_func_data.nii.gz</span></code> (the preprocessed functional data) file in the Ortho view.</p>
<div class='alert alert-warning'>
    <b>ToDo</b>: FSLeyes has a specialized viewing "mode" for inspecting FEAT directories. To activate this, go to View &rarr; Layouts &rarr; FEAT mode. Activating this layout will additionally open the time series viewer  and "Cluster browser" on the right. You may close the Cluster browser for now.
</div><p>The time series viewer now shows you both the data (<span class="math notranslate nohighlight">\(y\)</span>) and the “full model fit” (<span class="math notranslate nohighlight">\(\hat{y}\)</span>,) for the voxel highlighted by the crosshairs.</p>
<div class='alert alert-warning'>
    <b>ToDo/ToThink</b>: Go to voxel $[31, 16, 22]$. You'll see that this voxel nicely follows our blocked design, but doesn't seem to differentiate between our conditions (face vs. house vs. place, etc.). Does this surprise you, given the particular brain area that this voxel is part of?
</div><p>Let’s load some statistic files to see the (whole-brain) effects of a particular contrast.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Let's view the $z$-values from the first contrast ($\beta_{face} > 0$): File &rarr; Add from file &rarr; go to the <tt>stats</tt> directory &rarr; select <tt>zstat1.nii.gz</tt>.
</div><div class='alert alert-info'>
    <b>ToThink</b> (ungraded): Usually, people show brain maps of $z$-values instead of $t$-values in their figures. Why do you think this is the case?
</div><div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): To make the data easier to interpret, set the colormap of <tt>zstat1</tt> to "Red-Yellow", set the minimum value to 2.6 (this approximately corresponds to $p<0.005$), and set the Opacity slider to about 50%. (Note that you could also have loaded the <tt>thresh_zstat1.nii.gz</tt> file from the main FEAT directory, which is already thresholded using the threshold that you set in the post-stats tab of the FEAT GUI.)
</div><p>In the time series viewer, we can also add additional time series, such as the fitted “COPE” corresponding to our first contrast. The fitted “COPE” basically represents the predicted time series for a particular contrast, i.e., <span class="math notranslate nohighlight">\(\mathbf{X}\mathbf{c}^{T}\mathbf{c}\hat{\beta}\)</span>. (Usually, however, the intercept added to the predicted time series regardless of whether it’s included in the contrast.)</p>
<p>For example, suppose that we want to compute the fitted COPE corresponding to the <span class="math notranslate nohighlight">\(\beta_{face} &gt; 0\)</span> contrast, we would do the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s load in the actual design matrix from the FEAT dir</span>
<span class="n">dm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feat_dir</span><span class="p">,</span> <span class="s1">&#39;design.mat&#39;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">dm_path</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]</span>  <span class="c1"># remove motion preds for clarity of example</span>

<span class="c1"># Define face &gt; 0 contrast vector</span>
<span class="c1"># Add new axis to make sure matrix product works</span>
<span class="c1"># Order: face, body, place, character, object, response</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>

<span class="c1"># Create some hypothetical beta vector</span>
<span class="n">est_betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
<span class="n">fitted_cope_face</span> <span class="o">=</span> <span class="n">X</span> <span class="o">@</span> <span class="n">c</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">c</span> <span class="o">@</span> <span class="n">est_betas</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fitted_cope_face</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Activity (A.U.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Fitted COPE for $\beta_</span><span class="si">{face}</span><span class="s2"> &gt; 0$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e7bc5433cb01ea0c643af222a65586427cf70607d5f26bca7dc06a3422f92d13.png" src="../../_images/e7bc5433cb01ea0c643af222a65586427cf70607d5f26bca7dc06a3422f92d13.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Change the <tt>est_betas</tt> vector in the cell above to a couple of other contrasts (e.g., $\beta_{character} > 0$) and observe how the fitted COPE time series changes.
</div><div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Back to FSLeyes. To add the fitted COPE time series of the first contrast, click the "wrench" icon <em>in the time series panel</em>, go to <tt>Time series settings for ses-1: filtered_func_data</tt>, and check the box next to <tt>Plot COPE1 fit (face)</tt>.
</div><p>In the time series viewer, you should see a new line corresponding to “COPE1 fit: face”.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Set your crosshairs at $[45, 17, 19]$. Notice that this voxel's $z$-value is very high: 15.39! However, if you look at the COPE1 fit, you'll notice that &mdash; while this voxel indeed seems to activate for faces &mdash; it does not <em>selectively</em> activate for faces (it seems also to activate in response to the other conditions).
</div><p>This is exactly the reason why we also defined the <span class="math notranslate nohighlight">\(4\times\beta_{face} - \beta_{body} - \beta_{place} - \beta_{character} - \beta_{object} &gt; 0\)</span> contrast (contrast nr. 4 in our analysis)! This contrast allows us to identify regions in the brain that are (relatively more) <em>specific</em> for faces than for other types of images. In fact, in the context of our functional localizer task, you could argue that the <span class="math notranslate nohighlight">\(\beta_{face} &gt; 0\)</span> contrast is largely useless.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Remove the <tt>zstat1</tt> file from the overlays (Overlay &rarr; Remove). Then, open the already thresholded <tt>thresh_zstat4.nii.gz</tt> from the ses-1.feat subfolder (File &rarr; Add from file &rarr; select <tt>thresh_zstat4.nii.gz</tt> &rarr; Open). Change to colormap to "Red-Yellow".
</div><p>Many voxels throughout the brain seem to specifically activate in response to images of faces (but beware: these brain images are not yet “properly” thresholded, so many of these voxels might actually be false positives, but that’s the topic of next week!). Two cluster of voxels, however, seem especially strongly activated: one centered at <span class="math notranslate nohighlight">\([24, 19, 21]\)</span> and another one centered at <span class="math notranslate nohighlight">\([23, 30, 13]\)</span>. Note that these clusters are present in both hemispheres, but the cluster in the right hemisphere is clearly more strongly activated, which is consistent with the apparent right-hemisphere bias in face processing (see e.g., <a class="reference external" href="https://www.jneurosci.org/content/17/11/4302">Kanwisher et al., 1997</a>).</p>
<div class='alert alert-info'>
<b>ToThink</b> (ungraded): Which functional regions do you think that these two clusters represent? (Hint: check out the <a href="https://en.wikipedia.org/wiki/Face_perception#Neuroanatomy_of_facial_processing">Face perception wiki page</a>.)
</div><div class='alert alert-warning'>
<b>ToDo</b> (ungraded): Go to the voxel at location $[23, 30, 13]$ and notice that the voxel signal seems to respond (relatively) more selectively to faces than to other conditions. But, at the risk of interpreting noise rather than signal, you can also see that this voxel is seemingly not *completely* specific to faces (e.g., there is some apparent face-unrelated activity around volume 20-40). Indeed, whether there are truly face-specific regions in the brain at all is still a matter of debate (see e.g., <a href="https://www.nature.com/articles/nn0800_764">Tarr & Gauthier, 2000</a>).
</div><div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Remove the <tt>thresh_zstat4.nii.gz</tt> file (or hide this overlay by clicking on the eye-icon in the Overlay list). Then, add the <tt>thresh_zstat3.nii.gz</tt> file, corresponding to the $\beta_{response} > 0$ contrast, and set the color map to "Red-Yellow" (or any other colormap that you prefer).
</div><div class='alert alert-info'>
    <b>ToThink</b> (1 point): Based on this brain map, you could with reasonable confidence conclude that the participant did not completely do the task correctly (or was instructed incorrectly). Explain why.
</div><p>YOUR ANSWER HERE</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (ungraded): Remove the <tt>thresh_zstat3.nii.gz</tt> file (or hide this overlay). Then, add the <tt>thresh_zstat7.nii.gz</tt> file, corresponding to the $\beta_{face} = \beta_{body} = \beta_{place} = \beta_{character} = \beta_{object} < 0$ contrast, and set the color map to "Red-Yellow" (or any other colormap that you prefer).
</div><p>This contrast shows you which voxels are more active during periods in which stimuli were absent than when stimuli were presented (regardless of condition). The pattern of voxels that are often found to be more active during “rest” than during (external) “stimulation” has been named the <a class="reference external" href="https://en.wikipedia.org/wiki/Default_mode_network">default mode network</a> (DMN), which may reflect daydreaming, episodic or autobiographical information processing, or self reflection (amongst others; the exact “function” of the DMN is still unclear).</p>
<div class='alert alert-warning'>
<b>ToDo/ToThink</b> (1 point): Go to voxel $[35, 62, 11]$ and add the time series of COPE6 (reflecting the contrast $\beta_{face} = \beta_{body} = \beta_{place} = \beta_{character} = \beta_{object} > 0$) and COPE7 (reflecting the "rest/DMN" contrast). You'll see that these time series ($c\hat{\beta}$) are exactly the same! Explain why this is the case.
</div><p>YOUR ANSWER HERE</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): Finally, let's check out the data that we <em>couldn't</em> explain: the residuals ($y - \hat{y}$) and the noise term ($\hat{\sigma}^{2}$). First, close all overlays (Overlay &rarr; Remove all). Then, open the <tt>res4d.nii.gz</tt> file (File &rarr; Open from file &rarr; select <tt>res4d.nii.gz</tt>). The time series viewer should now show the residual time series from the voxel highlighted by your crosshairs. Also add the <tt>sigmasquareds.nii.gz</tt> file (i.e., the $\hat{\sigma}^{2}$ term for every voxel; File &rarr; Add from file &rarr; select <tt>sigmasquareds.nii.gz</tt>). Set the colormap for the "sigmasquareds" overlay to "Red-Yellow" and the Max. value to 40000.
</div><p>This <code class="docutils literal notranslate"><span class="pre">sigmasquareds</span></code> map (and the underlying “raw” residual time series) can given you a good overview of the noise in your data and potential violations of GLM (e.g., unequal or correlated error variance). This is a great way to check for unexpected issues (e.g., artifacts) with your data, that will, if unmodelled, end up in your noise term.</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (not graded): If you scroll through the <tt>sigmasquareds</tt> map, you'll notice that some regions contain more "unmodelled noise" than others. For example, if you go to voxel $[37, 23, 2]$, located in the brain stem, you can see that the corresponding residual time course contains a strong periodic ("oscillating") component. Because our scan has a relatively fast TR (0.7 seconds), this time course represents most likely signal related to pulsatile cerebral bloodflow caused the participant's heartbeat.
</div><p>This particular voxel lies most likely within the <a class="reference external" href="https://en.wikipedia.org/wiki/Circle_of_Willis">Circle of Willis</a>: a “hub” of multiple arteries supplying blood to the brain. As BOLD MRI measures the (relative) amount of oxygenated blood in the brain, it is no surprise that arteries (and veins!) produce a strong heartbeat-related signal, which will, if left unmodelled, make up much of the unexplained variance. Indeed, in this <code class="docutils literal notranslate"><span class="pre">sigmasquareds</span></code> map, most of voxels with high values (i.e., those that are relatively yellow) are located within or near arteries or veins. For example, you can clearly “see” the sagittal sinus (see image below).</p>
<p><img alt="" src="https://upload.wikimedia.org/wikipedia/commons/a/a2/1315_Brain_Sinuses.jpg" />
<em>From Wikimedia commons</em> (<a class="reference external" href="https://commons.wikimedia.org/wiki/File:1315_Brain_Sinuses.jpg">link</a>)</p>
<p>Apart from the veins/arteries, the cerebrospinal fluid (CSF) also seem to contain a lot of unmodelled noise. In fact, most of this unmodelled variance also likely represents the pulsative cerebral bloodflow, as shown (exaggerated) in the image below:</p>
<p><img alt="csf_pulse" src="https://upload.wikimedia.org/wikipedia/commons/3/38/NPH_MRI_272_GILD.gif" /><br></p>
<center><i>From Wikipedia, https://en.wikipedia.org/wiki/Cerebrospinal_fluid</i></center><div class='alert alert-warning'>
<b>ToDo</b> (not graded): Go to voxel $[37, 23, 2]$ and press the big "+" icon in the header of the Time series panel. This will "pin" this particular time series in the viewer. Click the wrench icon and under <tt>Plot settings for res4d</tt>, change the <tt>Colour</tt> to red (which will change the color of the currently highlighted time series line). 
<p>Now, move your crosshair across different voxels with high values (i.e., relatively yellow ones), for example voxel <span class="math notranslate nohighlight">\([37, 48, 17]\)</span> (located in the CSF). You can see that this voxel’s residual time series is highly (but not perfectly) correlated to the original voxel in the Circle of Willis, the common cause being the pulsative cerebral blood flow. (Note, though, that different voxels may show time series that look slightly shifted in time relative to the original Circle of Willis voxel, especially in more superior regions of the brain, which is caused by different slice onsets!)</p>
<p>Also note that the absolute signal amplitude of voxels within veins/arteries is <tt>much</tt> higher than voxels in gray matter!</p>
</div><p>Alright, time for something else: let’s delve into how you can “combine” run or session data in the next notebook (<code class="docutils literal notranslate"><span class="pre">run_level_analyses.ipynb</span></code>).</p>
<div class='alert alert-success'>
    <b>Tip!</b>
    Before handing in your notebooks, we recommend restarting your kernel (<em>Kernel</em> &rarr; <em>Restart & Clear Ouput</em>) and running all your cells again (manually, or by <em>Cell</em> &rarr; <em>Run all</em>). By running all your cells one by one (from "top" to "bottom" of the notebook), you may spot potential errors that are caused by accidentally overwriting your variables or running your cells out of order (e.g., defining the variable 'x' in cell 28 which you then use in cell 15).
</div></div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./fMRI-introduction/week_5"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="linux_and_the_command_line.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Linux and the command line</p>
      </div>
    </a>
    <a class="right-next"
       href="run_level_analyses.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Run-level analyses</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-fsleyes">Using FSLeyes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#skullstripping">Skullstripping</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-ni-edu-dataset">The “NI-edu” dataset</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#contents-of-the-dataset">Contents of the dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mri-acquisition-parameters">MRI acquisition parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-paradigms">Experimental paradigms</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#functional-localizer-task">Functional localizer task</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#face-perception-task">Face perception task</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-fsl-feat-for-preprocessing-and-first-level-analysis">Using FSL FEAT for preprocessing and first-level analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-primer-on-the-summary-statistics-approach">A primer on the “summary statistics” approach</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#first-level-analyses-and-preprocessing-in-feat">First-level analyses (and preprocessing) in FEAT</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-data-tab">The “Data” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-pre-stats-tab">The “Pre-stats” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-registration-tab">The “Registration” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-stats-tab">The “Stats” tab</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-post-stats-tab">The “Post-stats” tab</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-sense-of-feat-output">Making sense of FEAT output</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-the-report-html-file">Checking the report.html file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#checking-out-the-results-from-feat-in-fsleyes">Checking out the results from FEAT (in FSLeyes)</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Lukas Snoek
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2021.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>