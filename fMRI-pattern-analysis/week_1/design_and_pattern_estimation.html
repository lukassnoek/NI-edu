

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Experimental design and pattern estimation &#8212; NI-edu</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'fMRI-pattern-analysis/week_1/design_and_pattern_estimation';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Machine learning (“decoding”) analyses" href="../week_2/decoding_analyses.html" />
    <link rel="prev" title="Statistics with Nilearn" href="../../fMRI-introduction/week_7/nilearn_stats.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/fmri.gif" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/fmri.gif" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome to NI-edu
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/about.html">About this course</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/installation.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">fMRI-introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/1_python.html">Python for (f)MRI analysis</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../other/python_recap.html">Python recap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_1/python_for_mri.html">Working with MRI data in Python (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/2_glm.html">Using the GLM to model fMRI data</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_2/glm_part1_estimation.html">The GLM: estimation (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_3/glm_part2_inference.html">The GLM: inference (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/3_design_of_experiments_T.html">Design of experiments</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_3/design_of_experiments.html">Design of experiments (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_3/neurodesign.html">Neurodesign (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/4_preprocessing.html">Preprocessing</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_4/temporal_preprocessing.html">Temporal preprocessing (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_4/spatial_preprocessing.html">Spatial preprocessing (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_4/fmriprep.html">Fmriprep (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/5_multilevel.html">First &amp; run-level analyses</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_5/linux_and_the_command_line.html">Linux and the CMD (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_5/first_level_analyses.html">First level analyses (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_5/run_level_analyses.html">Run-level analyses (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/6_grouplevel.html">Group-level analyses</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_6/group_level_analyses.html">Group-level analyses (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_6/MCC.html">Multiple comparison correction (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_6/ROI_analysis.html">ROI analysis (T)</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../section_intros/7_nilearn.html">Introduction to Nilearn</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_7/nilearn.html">Introduction to Nilearn (T)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fMRI-introduction/week_7/nilearn_stats.html">Statistics with Nilearn (T)</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">fMRI-pattern-analysis</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Design and pattern estimation (T)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week_2/decoding_analyses.html">Machine learning/decoding (T)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../week_3/rsa.html">Representational Similarity Analysis (T)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../misc/bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/for_educators.html">For educators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/CONDUCT.html">Code of Conduct</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/lukassnoek/NI-edu/master?urlpath=tree/NI-edu/fMRI-pattern-analysis/week_1/design_and_pattern_estimation.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://neuroimaging.lukas-snoek.com/hub/user-redirect/git-pull?repo=https%3A//github.com/lukassnoek/NI-edu&urlpath=tree/NI-edu/NI-edu/fMRI-pattern-analysis/week_1/design_and_pattern_estimation.ipynb&branch=master" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onJupyterHub"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_jupyterhub.svg">
  </span>
<span class="btn__text-container">JupyterHub</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu/edit/master/NI-edu/fMRI-pattern-analysis/week_1/design_and_pattern_estimation.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/lukassnoek/NI-edu/issues/new?title=Issue%20on%20page%20%2FfMRI-pattern-analysis/week_1/design_and_pattern_estimation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/fMRI-pattern-analysis/week_1/design_and_pattern_estimation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Experimental design and pattern estimation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-design">Experimental design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#within-subject-vs-between-subject-analyses">Within-subject vs. between-subject analyses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confounds">Confounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-makes-up-a-pattern">What makes up a “pattern”?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#patterns-as-points-in-space">Patterns as “points in space”</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-patterns">Estimating patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#important-side-note-single-trials-vs-runwise-average-trials">Important side note: single trials vs. (runwise) average trials</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timepoint-based-methods">Timepoint-based methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glm-based-methods">GLM-based methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#least-squares-all-lsa">Least-squares all (LSA)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#noise-normalization">Noise normalization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lsa-on-real-data">LSA on real data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-trial-correlations">Dealing with trial correlations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#least-squares-separate-lss">Least-squares separate (LSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-uncorrelation">Temporal uncorrelation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="tex2jax_ignore mathjax_ignore section" id="experimental-design-and-pattern-estimation">
<h1>Experimental design and pattern estimation<a class="headerlink" href="#experimental-design-and-pattern-estimation" title="Permalink to this heading">#</a></h1>
<p>This week’s lab will be about the basics of pattern analysis of (f)MRI data. We assume that you’ve worked through the two Nilearn tutorials already.</p>
<p>Functional MRI data are most often stored as 4D data, with 3 spatial dimensions (<span class="math notranslate nohighlight">\(X\)</span>, <span class="math notranslate nohighlight">\(Y\)</span>, and <span class="math notranslate nohighlight">\(Z\)</span>) and 1 temporal dimension (<span class="math notranslate nohighlight">\(T\)</span>). But most pattern analyses assume that data are formatted in 2D: trials (<span class="math notranslate nohighlight">\(N\)</span>) by patterns (often a subset of <span class="math notranslate nohighlight">\(X\)</span>, <span class="math notranslate nohighlight">\(Y\)</span>, and <span class="math notranslate nohighlight">\(Z\)</span>). Where did the time dimension (<span class="math notranslate nohighlight">\(T\)</span>) go? And how do we “extract” the patterns of the <span class="math notranslate nohighlight">\(N\)</span> trials? In this lab, we’ll take a look at various methods to estimate patterns from fMRI time series. Because these methods often depend on your experimental design (and your research question, of course), the first part of this lab will discuss some experimental design considerations. After this more theoretical part, we’ll dive into how to estimate patterns from fMRI data.</p>
<p><strong>What you’ll learn</strong>: At the end of this tutorial, you …</p>
<ul class="simple">
<li><p>Understand the most important experimental design factors for pattern analyses;</p></li>
<li><p>Understand and are able to implement different pattern estimation techniques</p></li>
</ul>
<p><strong>Estimated time needed to complete</strong>: 8-12 hours</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We need to limit the amount of threads numpy can use, otherwise</span>
<span class="c1"># it tends to hog all the CPUs available when using Nilearn</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MKL_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENBLAS_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="experimental-design">
<h2>Experimental design<a class="headerlink" href="#experimental-design" title="Permalink to this heading">#</a></h2>
<p>Before you can do any fancy machine learning or representational similarity analysis (or any other pattern analysis), there are several decisions you need to make and steps to take in terms of study design, (pre)processing, and structuring your data. Roughly, there are three steps to take:</p>
<ol class="arabic simple">
<li><p>Design your study in a way that’s appropriate to answer your question through a pattern analysis; this, of course, needs to be done <em>before</em> data acquisition!</p></li>
<li><p>Estimate/extract your patterns from the (functional) MRI data;</p></li>
<li><p>Structure and preprocess your data appropriately for pattern analyses;</p></li>
</ol>
<p>While we won’t go into all the design factors that make for an <em>efficient</em> pattern analysis (see <a class="reference external" href="http://www.sciencedirect.com/science/article/pii/S105381191400768X">this article</a> for a good review), we will now discuss/demonstrate some design considerations and how they impact the rest of the MVPA pipeline.</p>
<div class="section" id="within-subject-vs-between-subject-analyses">
<h3>Within-subject vs. between-subject analyses<a class="headerlink" href="#within-subject-vs-between-subject-analyses" title="Permalink to this heading">#</a></h3>
<p>As always, your experimental design depends on your specific research question. If, for example, you’re trying to predict schizophrenia patients from healthy controls based on structural MRI, your experimental design is going to be different than when you, for example, are comparing fMRI activity patterns in the amygdala between trials targeted to induce different emotions. Crucially, with <em>design</em> we mean the factors that you as a researcher control: e.g., which schizophrenia patients and healthy control to scan in the former example and which emotion trials to present at what time. These two examples indicate that experimental design considerations are quite different when you are trying to model a factor that varies <em>between subjects</em> (the schizophrenia vs. healthy control example) versus a factor that varies <em>within subjects</em> (the emotion trials example).</p>
<div class='alert alert-warning'>
<b>ToDo/ToThink</b> (1.5 points): before continuing, let's practice a bit. For the three articles below, determine whether they used a within-subject or between-subject design.<br>
<ol>
    <li><a href="https://www.nature.com/articles/nn1444">https://www.nature.com/articles/nn1444</a> (machine learning based)</li>
    <li><a href="http://www.jneurosci.org/content/33/47/18597.short">http://www.jneurosci.org/content/33/47/18597.short</a> (RSA based)</li>
    <li><a href="https://www.sciencedirect.com/science/article/pii/S1053811913000074">https://www.sciencedirect.com/science/article/pii/S1053811913000074</a> (machine learning based)</li>
</ol>
<p>Assign either ‘within’ or ‘between’ to the variables corresponding to the studies above (i.e., <tt>study_1</tt>, <tt>study_2</tt>, <tt>study_3</tt>).</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement the ToDo here. &#39;&#39;&#39;</span>
<span class="n">study_1</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># fill in &#39;within&#39; or &#39;between&#39;</span>
<span class="n">study_2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># fill in &#39;within&#39; or &#39;between&#39;</span>
<span class="n">study_3</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># fill in &#39;within&#39; or &#39;between&#39;</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>    
<span class="k">for</span> <span class="n">this_study</span> <span class="ow">in</span> <span class="p">[</span><span class="n">study_1</span><span class="p">,</span> <span class="n">study_2</span><span class="p">,</span> <span class="n">study_3</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">this_study</span><span class="p">:</span>  <span class="c1"># if empty string</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You haven&#39;t filled in anything!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">this_study</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;within&#39;</span><span class="p">,</span> <span class="s1">&#39;between&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fill in either &#39;within&#39; or &#39;between&#39;!&quot;</span><span class="p">)</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your answer will be graded by hidden tests.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note that, while we think it is a useful way to think about different types of studies, it is possible to use “hybrid” designs and analyses. For example, you could compare patterns from a particular condition (within-subject) across different participants (between-subject). This is, to our knowledge, not very common though, so we won’t discuss it here.</p>
<div class='alert alert-info'>
<b>ToThink</b> (1 point)<br>
Suppose a researcher wants to implement a decoding analysis in which he/she aims to predict schizophrenia (vs. healthy control) from gray-matter density patterns in the orbitofrontal cortex. Is this an example of a within-subject or between-subject pattern analysis? Can it be either one? Why (not)? 
</div><p>YOUR ANSWER HERE</p>
<p>That said, let’s talk about something that is not only important for univariate MRI analyses, but also for pattern-based multivariate MRI analyses: confounds.</p>
</div>
<div class="section" id="confounds">
<h3>Confounds<a class="headerlink" href="#confounds" title="Permalink to this heading">#</a></h3>
<p>For most task-based MRI analyses, we try to relate features from our experiment (stimuli, responses, participant characteristics; let’s call these <span class="math notranslate nohighlight">\(\mathbf{S}\)</span>) to brain features (this is not restricted to “activity patterns”; let’s call these <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>*). Ideally, we have designed our experiment that any association between our experimental factor of interest (<span class="math notranslate nohighlight">\(\mathbf{S}\)</span>) and brain data (<span class="math notranslate nohighlight">\(\mathbf{R}\)</span>) can <em>only</em> be due to our experimental factor, not something else.</p>
<p>If another factor besides our experimental factor of interest can explain this association, this “other factor” may be a <em>confound</em> (let’s call this <span class="math notranslate nohighlight">\(\mathbf{C}\)</span>). If we care to conclude anything about our experimental factor of interest and its relation to our brain data, we should try to minimize any confounding factors in our design.</p>
<hr class="docutils" />
<p>* Note that the notation for experimental variables (<span class="math notranslate nohighlight">\(\mathbf{S}\)</span>) and brain features (<span class="math notranslate nohighlight">\(\mathbf{R}\)</span>) is different from what we used in the previous course, in which we used <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> for experimental variables and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> for brain signals. We did this to conform to the convention to use <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> for the set of independent variables and <span class="math notranslate nohighlight">\(\mathbf{y}\)</span> for dependent variables. In some pattern analyses (such as RSA), however, this independent/dependent variable distintion does not really apply, so that’s why we’ll stick to the more generic <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> (for brain features) and <span class="math notranslate nohighlight">\(\mathbf{S}\)</span> (for experimental features) terms.</p>
<div class='alert alert-success'>
    <b>Note</b>: In some situations, you may only be interested in maximizing your explanatory/predictive power; in that case, you could argue that confounds are not a problem. The article by <a href="https://www.sciencedirect.com/science/article/pii/S1053811917306523"> Hebart & Baker (2018)</a> provides an excellent overview of this issue.
</div><p>Statistically speaking, you should design your experiment in such a way that there are no associations (correlations) between <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{C}\)</span>, such that any association between <span class="math notranslate nohighlight">\(\mathbf{S}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> can <em>only</em> be due to <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>. Note that this is not trivial, because this presumes that you (1) know which factors might confound your study and (2) if you know these factors, that they are measured properly (<a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0152719">Westfall &amp; Yarkoni, 2016)</a>).</p>
<p>Minimizing confounds in between-subject studies is notably harder than in within-subject designs, especially when dealing with clinical populations that are hard to acquire, because it is simply easier to experimentally control within-subject factors (especially when they are stimulus- rather than response-based). There are ways to deal with confounds post-hoc, but ideally you prevent confounds in the first place. For an overview of confounds in (multivariate/decoding) neuroimaging analyses and a proposed post-hoc correction method, see <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811918319463">this article</a> (apologies for the shameless self-promotion) and <a class="reference external" href="https://www.biorxiv.org/content/10.1101/2020.08.17.255034v1.abstract">this follow-up article</a>.</p>
<p>In sum, as with <em>any</em> (neuroimaging) analysis, a good experimental design is one that minimizes the possibilities of confounds, i.e., associations between factors that are not of interest (<span class="math notranslate nohighlight">\(\mathbf{C}\)</span>) and experimental factors that <em>are</em> of interest (<span class="math notranslate nohighlight">\(\mathbf{S}\)</span>).</p>
<div class='alert alert-info'>
    <b>ToThink</b> (0 points): Suppose that you are interested in the neural correlates of ADHD. You want to compare multivariate resting-state fMRI networks between ADHD patients and healthy controls. What is the experimental factor ($\mathbf{S}$)? And can you think of a factor that, when unaccounted for, presents a major confound ($\mathbf{C}$) in this study/analysis? 
</div><div class='alert alert-info'>
    <b>ToThink</b> (1 point): Suppose that you're interested in the neural representation of "cognitive effort". You think of an experimental design in which you show participants either easy arithmetic problems, which involve only single-digit addition/subtraction (e.g., $2+5-4$) or hard(er) arithmetic problems, which involve two-digit addition/subtraction and multiplication (e.g., $12\times4-2\times11$), for which they have to respond whether the solution is odd (press left) or even (press right) as fast as possible. You then compare patterns during the between easy and hard trials. What is the experimental factor of interest ($\mathbf{S}$) here? And what are <em>possible</em> confounds ($\mathbf{C}$) in this design? Name at least two. (Note: this is a separate hypothetical experimental from the previous ToThink.)
</div><p>YOUR ANSWER HERE</p>
</div>
<div class="section" id="what-makes-up-a-pattern">
<h3>What makes up a “pattern”?<a class="headerlink" href="#what-makes-up-a-pattern" title="Permalink to this heading">#</a></h3>
<p>So far, we talked a lot about “patterns”, but what do we mean with that term? There are different options with regard to <em>what you choose as your unit of measurement</em> that makes up your pattern. The far majority of pattern analyses in functional MRI use patterns of <em>activity estimates</em>, i.e., the same unit of measurement — relative (de)activation — as is common in standard mass-univariate analyses. For example, decoding object category (e.g., images of faces vs. images of houses) from fMRI activity patterns in inferotemporal cortex is an example of a pattern analysis that uses <em>activity estimates</em> as its unit of measurement.</p>
<p>However, you are definitely not limited to using <em>activity estimates</em> for your patterns. For example, you could apply pattern analyses to structural data (e.g., patterns of voxelwise gray-matter volume values, like in <a class="reference external" href="https://en.wikipedia.org/wiki/Voxel-based_morphometry">voxel-based morphometry</a>) or to functional connectivity data (e.g., patterns of time series correlations between voxels, or even topological properties of brain networks). (In fact, the connectivity examples from the Nilearn tutorial represents a way to estimate these connectivity features, which can be used in pattern analyses.) In short, pattern analyses can be applied to patterns composed of <em>any</em> type of measurement or metric!</p>
<p>Now, let’s get a little more technical. Usually, as mentioned in the beginning, pattern analyses represent the data as a 2D array of brain patterns. Let’s call this <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>. The rows of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> represent different instances of patterns (sometimes called “samples” or “observations”) and the columns represent different brain features (e.g., voxels; sometimes simply called “features”). Note that we thus lose all spatial information by “flattening” our patterns into 1D rows!</p>
<p>Let’s call the number of samples <span class="math notranslate nohighlight">\(N\)</span> and the number of brain features <span class="math notranslate nohighlight">\(K\)</span>. We can thus represent <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> as a <span class="math notranslate nohighlight">\(N\times K\)</span> matrix (2D array):</p>
<div class="amsmath math notranslate nohighlight" id="equation-2fa9739f-e562-45ab-9c86-b9d2af9f5d2f">
<span class="eqno">(88)<a class="headerlink" href="#equation-2fa9739f-e562-45ab-9c86-b9d2af9f5d2f" title="Permalink to this equation">#</a></span>\[\begin{align}
\mathbf{R} = 
\begin{bmatrix}
 R_{1,1} &amp; R_{1,2} &amp; R_{1,3} &amp; \dots &amp; R_{1,K}\\
 R_{2,1} &amp; R_{1,2} &amp; R_{1,3} &amp; \dots &amp; R_{2,K}\\
 R_{3,1} &amp; R_{1,2} &amp; R_{1,3} &amp; \dots &amp; R_{3,K}\\
 \vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots\\ 
 R_{N,1} &amp; R_{1,2} &amp; R_{1,3} &amp; \dots &amp; R_{N,K}\\
\end{bmatrix}
\end{align}\]</div>
<p>As discussed before, the values themselves (e.g., <span class="math notranslate nohighlight">\(R_{1,1}\)</span>, <span class="math notranslate nohighlight">\(R_{1,2}\)</span>, <span class="math notranslate nohighlight">\(R_{3,6}\)</span>) represent whatever you chose for your patterns (fMRI activity, connectivity estimates, VBM, etc.). What is represented by the rows (samples/observations) of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> depends on your study design: in between-subject studies, these are usually participants, while in within-subject studies, these samples represent trials (or averages of trials or sometimes runs). The columns of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span> represent the different (brain) features in your pattern; for example, these may be different voxels (or sensors/magnetometers in EEG/MEG), vertices (when working with cortical surfaces), edges in functional brain networks, etc. etc.</p>
<p>Let’s make it a little bit more concrete. We’ll make up some random data below that represents a typical data array in pattern analyses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># e.g. trials</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">250</span>   <span class="c1"># e.g. voxels</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">))</span>
<span class="n">R</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.15339263, -0.22330473, -0.64831454, ..., -0.73946864,
         1.25998358,  0.00431696],
       [ 0.86280123, -1.42090204, -0.05381566, ..., -1.01176081,
         0.24330926,  0.36903122],
       [ 1.41362587,  0.89873264, -0.98157562, ..., -0.46425587,
         1.28319916,  0.14008011],
       ...,
       [-0.32058043, -1.20927449, -1.49755011, ..., -1.57452056,
         0.07369649,  1.61001617],
       [ 0.20092411, -0.06283372,  0.88994314, ..., -2.03043571,
         0.17528074,  0.53970261],
       [ 1.02283767, -0.90966306, -0.27389087, ..., -0.52319604,
         1.62955379,  0.85457804]])
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Brain features&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Samples&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mathbf</span><span class="si">{R}</span><span class="s1">_{N\times K}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Feature value&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/4ffae1e1dfe119f2bca144a4a0b38c70528c81c8582f55ea2471e3a72b966e0b.png" src="../../_images/4ffae1e1dfe119f2bca144a4a0b38c70528c81c8582f55ea2471e3a72b966e0b.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (1 point): Extract the pattern of the 42nd trial and store it in a variable called <tt>trial42</tt>. Then, extract the values of 187th brain feature across all trials and store it in a variable called <tt>feat187</tt>. Lastly, extract feature value of the 60th trial and the 221nd feature and store it in a variable called <tt>t60_f221</tt>. Remember: Python uses zero-based indexing (first value in an array is indexed by 0)!
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement the ToDo here.&#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_R_indexing</span>
<span class="n">test_R_indexing</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">trial42</span><span class="p">,</span> <span class="n">feat187</span><span class="p">,</span> <span class="n">t60_f221</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Alright, to practice a little bit more. We included whole-brain VBM data for 20 subjects in the <code class="docutils literal notranslate"><span class="pre">vbm/</span></code> subfolder:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;vbm&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;sub-01.nii.gz&#39;,
 &#39;sub-02.nii.gz&#39;,
 &#39;sub-03.nii.gz&#39;,
 &#39;sub-04.nii.gz&#39;,
 &#39;sub-05.nii.gz&#39;,
 &#39;sub-06.nii.gz&#39;,
 &#39;sub-07.nii.gz&#39;,
 &#39;sub-08.nii.gz&#39;,
 &#39;sub-09.nii.gz&#39;,
 &#39;sub-10.nii.gz&#39;,
 &#39;sub-11.nii.gz&#39;,
 &#39;sub-12.nii.gz&#39;,
 &#39;sub-13.nii.gz&#39;,
 &#39;sub-14.nii.gz&#39;,
 &#39;sub-15.nii.gz&#39;,
 &#39;sub-16.nii.gz&#39;,
 &#39;sub-17.nii.gz&#39;,
 &#39;sub-18.nii.gz&#39;,
 &#39;sub-19.nii.gz&#39;,
 &#39;sub-20.nii.gz&#39;]
</pre></div>
</div>
</div>
</div>
<p>The VBM data represents spatially normalized (to MNI152, 2mm), whole-brain voxelwise gray matter volume estimates (read more about VBM <a class="reference external" href="https://en.wikipedia.org/wiki/Voxel-based_morphometry">here</a>).</p>
<p>Let’s inspect the data from a single subject:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>

<span class="n">sub_01_vbm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;vbm&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-01.nii.gz&#39;</span><span class="p">)</span>
<span class="n">sub_01_vbm</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sub_01_vbm_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of Nifti file: &quot;</span><span class="p">,</span> <span class="n">sub_01_vbm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Let&#39;s plot it as well</span>
<span class="n">plotting</span><span class="o">.</span><span class="n">plot_anat</span><span class="p">(</span><span class="n">sub_01_vbm</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape of Nifti file:  (91, 109, 91)
</pre></div>
</div>
<img alt="../../_images/97542323d9383321170a002131300430b2307673222f9ec4b9eda10c37f30ade.png" src="../../_images/97542323d9383321170a002131300430b2307673222f9ec4b9eda10c37f30ade.png" />
</div>
</div>
<p>As you can see, the VBM data is a 3D array of shape 91 (<span class="math notranslate nohighlight">\(X\)</span>) <span class="math notranslate nohighlight">\(\times\)</span> 109 (<span class="math notranslate nohighlight">\(Y\)</span>) <span class="math notranslate nohighlight">\(\times\)</span> 91 (<span class="math notranslate nohighlight">\(Z\)</span>) (representing voxels). These are the spatial dimensions associated with the standard MNI152 (2 mm) template provided by FSL. As VBM is structural (not functional!) data, there is no time dimension (<span class="math notranslate nohighlight">\(T\)</span>).</p>
<p>Now, suppose that we want to do a pattern analysis on the data of all 20 subjects. We should then create a 2D array of shape 20 (subjects) <span class="math notranslate nohighlight">\(\times\ K\)</span> (number of voxels, i.e., <span class="math notranslate nohighlight">\(91 \times 109 \times 91\)</span>). To do so, we need to create a loop over all files, load them in, “flatten” the data, and ultimately stack them into a 2D array.</p>
<p>Before you’ll implement this as part of the next ToDo, we will show you a neat Python function called <code class="docutils literal notranslate"><span class="pre">glob</span></code>, which allows you to simply find files using “<a class="reference external" href="https://en.wikipedia.org/wiki/Wildcard_character">wildcards</a>”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
</pre></div>
</div>
</div>
</div>
<p>It works as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">list_of_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;path/with/subdirectories/*/*.nii.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Importantly, the string you pass to <code class="docutils literal notranslate"><span class="pre">glob</span></code> can contain one or more wildcard characters (such as <code class="docutils literal notranslate"><span class="pre">?</span></code> or <code class="docutils literal notranslate"><span class="pre">*</span></code>). Also, <em>the returned list is not sorted</em>! Let’s try to get all our VBM subject data into a list using this function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s define a &quot;search string&quot;; we&#39;ll use the os.path.join function</span>
<span class="c1"># to make sure this works both on Linux/Mac and Windows</span>
<span class="n">search_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;vbm&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-*.nii.gz&#39;</span><span class="p">)</span>
<span class="n">vbm_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">search_str</span><span class="p">)</span>

<span class="c1"># this is also possible: vbm_files = glob(os.path.join(&#39;vbm&#39;, &#39;sub-*.nii.gz&#39;))</span>

<span class="c1"># Let&#39;s print the returned list</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vbm_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;vbm/sub-12.nii.gz&#39;, &#39;vbm/sub-02.nii.gz&#39;, &#39;vbm/sub-10.nii.gz&#39;, &#39;vbm/sub-14.nii.gz&#39;, &#39;vbm/sub-18.nii.gz&#39;, &#39;vbm/sub-06.nii.gz&#39;, &#39;vbm/sub-20.nii.gz&#39;, &#39;vbm/sub-04.nii.gz&#39;, &#39;vbm/sub-16.nii.gz&#39;, &#39;vbm/sub-08.nii.gz&#39;, &#39;vbm/sub-13.nii.gz&#39;, &#39;vbm/sub-01.nii.gz&#39;, &#39;vbm/sub-03.nii.gz&#39;, &#39;vbm/sub-11.nii.gz&#39;, &#39;vbm/sub-15.nii.gz&#39;, &#39;vbm/sub-07.nii.gz&#39;, &#39;vbm/sub-19.nii.gz&#39;, &#39;vbm/sub-05.nii.gz&#39;, &#39;vbm/sub-09.nii.gz&#39;, &#39;vbm/sub-17.nii.gz&#39;]
</pre></div>
</div>
</div>
</div>
<p>As you can see, <em>the list is not alphabetically sorted</em>, so let’s fix that with the <code class="docutils literal notranslate"><span class="pre">sorted</span></code> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vbm_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vbm_files</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">vbm_files</span><span class="p">)</span>
<span class="c1"># Note that we could have done that with a single statement</span>
<span class="c1"># vbm_files = sorted(glob(os.path.join(&#39;vbm&#39;, &#39;sub-*.nii.gz&#39;)))</span>
<span class="c1"># But also remember: shorter code is not always better!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;vbm/sub-01.nii.gz&#39;, &#39;vbm/sub-02.nii.gz&#39;, &#39;vbm/sub-03.nii.gz&#39;, &#39;vbm/sub-04.nii.gz&#39;, &#39;vbm/sub-05.nii.gz&#39;, &#39;vbm/sub-06.nii.gz&#39;, &#39;vbm/sub-07.nii.gz&#39;, &#39;vbm/sub-08.nii.gz&#39;, &#39;vbm/sub-09.nii.gz&#39;, &#39;vbm/sub-10.nii.gz&#39;, &#39;vbm/sub-11.nii.gz&#39;, &#39;vbm/sub-12.nii.gz&#39;, &#39;vbm/sub-13.nii.gz&#39;, &#39;vbm/sub-14.nii.gz&#39;, &#39;vbm/sub-15.nii.gz&#39;, &#39;vbm/sub-16.nii.gz&#39;, &#39;vbm/sub-17.nii.gz&#39;, &#39;vbm/sub-18.nii.gz&#39;, &#39;vbm/sub-19.nii.gz&#39;, &#39;vbm/sub-20.nii.gz&#39;]
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): Create a 2D array with the vertically stacked subject-specific (flattened) VBM patterns, in which the first subject should be the first row. You may want to pre-allocate this array before starting your loop (using, e.g., <tt>np.zeros</tt>). Also, the <tt>enumerate</tt> function may be useful when writing your loop. Try to google how to flatten an N-dimensional array into a single vector. Store the final 2D array in a variable named <tt>R_vbm</tt>.
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement the ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_R_vbm_loop</span>
<span class="n">test_R_vbm_loop</span><span class="p">(</span><span class="n">R_vbm</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-success'>
    <b>Tip</b>: While it is a good exercise to load in the data yourself, you can also easily load in and concatenate a set of Nifti files using Nilearn's <a href="https://nilearn.github.io/modules/generated/nilearn.image.concat_imgs.html">concat_imgs</a> function (which returns a 4D <tt>Nifti1Image</tt>, with the different patterns as the fourth dimension). You'd still have to reorganize this data into a 2D array, though.
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run this cell after you&#39;re done with the ToDo</span>
<span class="c1"># This will remove the all numpy arrays from memory,</span>
<span class="c1"># clearing up RAM for the next sections</span>
<span class="o">%</span><span class="k">reset</span> -f array
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="patterns-as-points-in-space">
<h3>Patterns as “points in space”<a class="headerlink" href="#patterns-as-points-in-space" title="Permalink to this heading">#</a></h3>
<p>Before we continue with the topic of pattern estimation, there is one idea that we’d like to introduce: thinking of patterns as points (i.e., coordinates) in space. Thinking of patterns this way is helpful to understanding both machine learning based analyses and representational similarity analysis. While for some, this idea might sound trivial, we believe it’s worth going over anyway. Now, let’s make this idea more concrete.</p>
<p>Suppose we have estimated fMRI activity patterns for 20 trials (rows of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>). Now, we will also assume that those patterns consist of only two features (e.g., voxels; columns of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>), because this will make visualizing patterns as points in space easier than when we choose a larger number of features.</p>
<p>Alright, let’s simulate and visualize the data (as a 2D array):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># features (voxels)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># samples (trials)</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">K</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of R:&quot;</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot 2D array as heatmap</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Feature value&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathbf</span><span class="si">{R}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Trials&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape of R: (20, 2)
</pre></div>
</div>
<img alt="../../_images/7afdd47d98f4763ddce566dd9558929bf0e818681ab47dee50de91d1aca81949.png" src="../../_images/7afdd47d98f4763ddce566dd9558929bf0e818681ab47dee50de91d1aca81949.png" />
</div>
</div>
<p>Now, we mentioned that each pattern (row of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>, i.e., <span class="math notranslate nohighlight">\(\mathbf{R}_{i}\)</span>) can be interpreted as a point in 2D space. With space, here, we mean a space where each feature (e.g., voxel; column of <span class="math notranslate nohighlight">\(\mathbf{R}\)</span>, i.e., <span class="math notranslate nohighlight">\(\mathbf{R}_{j}\)</span>) represents a separate axis. In our simulated data, we have two features (e.g., voxel 1 and voxel 2), so our space will have two axes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;A two-dimensional space&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/993acb1b2b0b09eb2f5f7729a60bf5766baacad05492712fc1d7a35863dae5aa.png" src="../../_images/993acb1b2b0b09eb2f5f7729a60bf5766baacad05492712fc1d7a35863dae5aa.png" />
</div>
</div>
<p>Within this space, each of our patterns (samples) represents a point. The values of each pattern represent the <em>coordinates</em> of its location in this space. For example, the coordinates of the first pattern are:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[-0.69508693  2.2473697 ]
</pre></div>
</div>
</div>
</div>
<p>As such, we can plot this pattern as a point in space:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;A two-dimensional space&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="c1"># We use the &quot;scatter&quot; function to plot this point, but</span>
<span class="c1"># we could also have used plt.plot(R[0, 0], R[0, 1], marker=&#39;o&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2f3188039f1d45e7a4f7b2fad4bd9d2b578338a1ddae9e80271f6b8050378253.png" src="../../_images/2f3188039f1d45e7a4f7b2fad4bd9d2b578338a1ddae9e80271f6b8050378253.png" />
</div>
</div>
<p>If we do this for all patterns, we get an ordinary scatter plot of the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;A two-dimensional space&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="c1"># We use the &quot;scatter&quot; function to plot this point, but</span>
<span class="c1"># we could also have used plt.plot(R[0, 0], R[0, 1], marker=&#39;o&#39;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Activity voxel 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/66642ebde3037bb112e5671afc9d20641f347bea5a071419e46f43366c104732.png" src="../../_images/66642ebde3037bb112e5671afc9d20641f347bea5a071419e46f43366c104732.png" />
</div>
</div>
<p>It is important to realize that both perspectives — as a 2D array and as a set of points in <span class="math notranslate nohighlight">\(K\)</span>-dimensional space — represents the same data! Practically, pattern analysis algorithms usually expect the data as a 2D array, but (in our experience) the operations and mechanisms implemented by those algorithms are easiest to explain and to understand from the “points in space” perspective.</p>
<p>You might think, “but how does this work for data with more than two features?” Well, the idea of patterns as points in space remains the same: each feature represents a new dimension (or “axis”). For three features, this means that a pattern represents a point in 3D (X, Y, Z) space; for four features, a pattern represents a point in 4D space (like a point moving in 3D space) … but what about a pattern with 14 features? Or 500? Actually, this is impossible to visualize or even make sense of mentally. As the famous artificial intelligence researcher Geoffrey Hinton put it:</p>
<blockquote>
<div><p>“To deal with … a 14 dimensional space, visualize a 3D space and say ‘fourteen’ very loudly. Everyone does it.” (Geoffrey Hinton)</p>
</div></blockquote>
<p>The important thing to understand, though, is that most operations, computations, and algorithms that deal with patterns do not care about whether your data is 2D (two features) or 14D (fourteen features) — we just have to trust the mathematicians that whatever we do on 2D data will generalize to <span class="math notranslate nohighlight">\(K\)</span>-dimensional data :-)</p>
<p>That said, people still try to visualize &gt;2D data using <em>dimensionality reduction</em> techniques. These techniques try to project data to a lower-dimensional space. For example, you can transform a dataset with 500 features (i.e., a 500-dimensional dataset) to a 2D dimensional dataset using techniques such as principal component analysis (PCA), Multidimensional Scaling (MDS), and t-SNE. For example, PCA tries to a subset of uncorrelated lower-dimensional features (e.g., 2) from  linear combinations of high-dimensional features (e.g., 4) that still represent as much variance of the high-dimensional components as possible. We’ll show you an example below using an implementation of PCA from the machine learning library <a class="reference external" href="https://scikit-learn.org/stable/">scikit-learn</a>, which we’ll use extensively in next week’s lab:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># Let&#39;s create a dataset with 100 samples and 4 features</span>
<span class="n">R4D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape R4D:&quot;</span><span class="p">,</span> <span class="n">R4D</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># We&#39;ll instantiate a PCA object that will</span>
<span class="c1"># transform our data into 2 components</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Fit and transform the data from 4D to 2D</span>
<span class="n">R2D</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">R4D</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape R2D:&quot;</span><span class="p">,</span> <span class="n">R2D</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot the result</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">R2D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">R2D</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;PCA component 1&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;PCA component 2&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape R4D: (100, 4)
Shape R2D: (100, 2)
</pre></div>
</div>
<img alt="../../_images/56cc41c312c3438f17fa01a25d17fa205da1e94f29dfb1757605e255a7807685.png" src="../../_images/56cc41c312c3438f17fa01a25d17fa205da1e94f29dfb1757605e255a7807685.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (optional): As discussed, PCA is a specific dimensionality reduction technique that uses linear combinations of features to project the data to a lower-dimensional space with fewer "components". Linear combinations are simply weighted sums of high-dimensional features. In a 4D dimensional space that is project to 2D, PCA component 1 might be computed as $\mathbf{R}_{j=1}\theta_{1}+\mathbf{R}_{j=2}\theta_{2}+\mathbf{R}_{j=3}\theta_{3}+\mathbf{R}_{j=4}\theta_{4}$, where $R_{j=1}$ represents the 4th feature of $\mathbf{R}$ and $\theta_{1}$ represents the <em>weight</em> for the 4th feature.
<p>The weights of the fitted PCA model can be accessed by, confusingly, <tt>pca.components_</tt> (shape: <span class="math notranslate nohighlight">\(K_{lower} \times K_{higher}\)</span>. Using these weights, can you recompute the lower-dimensional features from the higher-dimensional features yourself? Try to plot it like the figure above and check whether it matches.</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement the (optional) ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note that dimensionality reduction is often used for visualization, but it can also be used as a preprocessing step in pattern analyses. We’ll take a look this in more detail next week.</p>
<p>Alright, back to the topic of pattern extraction/estimation. You saw that preparing VBM data for (between-subject) pattern analyses is actually quite straightforward, but unfortunately, preparing functional MRI data for pattern analysis is a little more complicated. The reason is that we are dealing with time series in which different trials (<span class="math notranslate nohighlight">\(N\)</span>) are “embedded”. The next section discusses different methods to “extract” (estimate) these trial-wise patterns.</p>
</div>
</div>
<div class="section" id="estimating-patterns">
<h2>Estimating patterns<a class="headerlink" href="#estimating-patterns" title="Permalink to this heading">#</a></h2>
<p>As we mentioned before, we should prepare our data as an <span class="math notranslate nohighlight">\(N\)</span> (samples) <span class="math notranslate nohighlight">\(\times\)</span> <span class="math notranslate nohighlight">\(K\)</span> (features) array. With fMRI data, our data is formatted as a <span class="math notranslate nohighlight">\(X \times Y \times Z \times T\)</span> array; we can flatten the <span class="math notranslate nohighlight">\(X\)</span>, <span class="math notranslate nohighlight">\(Y\)</span>, and <span class="math notranslate nohighlight">\(Z\)</span> dimensions, but we still have to find a way to “extract” patterns for our <span class="math notranslate nohighlight">\(N\)</span> trials from the time series (i.e., the <span class="math notranslate nohighlight">\(T\)</span> dimension).</p>
<div class="section" id="important-side-note-single-trials-vs-runwise-average-trials">
<h3>Important side note: single trials vs. (runwise) average trials<a class="headerlink" href="#important-side-note-single-trials-vs-runwise-average-trials" title="Permalink to this heading">#</a></h3>
<p>In this section, we often assume that our “samples” refer to different <em>trials</em>, i.e., single instances of a stimulus or response (or another experimentally-related factor). This is, however, not the only option. Sometimes, researchers choose to treat multiple repetitions of a trial as a single sample or multiple trials within a condition as a single sample. For example, suppose you design a simple passive-viewing experiment with images belonging two one of three conditions: faces, houses, and chairs. Each condition has ten exemplars (face1, face2, …, face10, house1, house2, …, house10, chair1, chair2, … , chair10) and each exemplar/item is repeated six times. So, in total there are 3 (condition) <span class="math notranslate nohighlight">\(\times\)</span> 10 (examplars) <span class="math notranslate nohighlight">\(\times\)</span> 6 (repetitions) = 180 trials. Because you don’t want to bore the participant to death, you split the 180 trials into two runs (90 each).</p>
<p>Now, there are different ways to define your samples. One is to treat every single trial as a sample (so you’ll have a 180 samples). Another way is to treat each exemplar as a sample. If you do so, you’ll have to “pool” the pattern estimates across all 6 repetitions (so you’ll have <span class="math notranslate nohighlight">\(10 \times 3 = 30\)</span> samples). And yet another way is to treat each condition as a sample, so you’ll have to pool the pattern estimates across all 6 repetitions and 10 exemplars per condition (so you’ll end up with only 3 samples). Lastly, with respect to the latter two approaches, you may choose to only average repetitions and/or exemplars <em>within</em> runs. So, for two runs, you end up with either <span class="math notranslate nohighlight">\(10 \times 3 \times 2 = 60\)</span> samples (when averaging across repetitions only) or <span class="math notranslate nohighlight">\(3 \times 2 = 6\)</span> samples (when averaging across examplars and repetitions).</p>
<p>Whether you should perform your pattern analysis on the trial, examplar, or condition level, and whether you should estimate these patterns across runs or within runs, depends on your research question and analysis technique. For example, if you want to decode exemplars from each other, you obviously should not average across exemplars. Also, some experiments may not have different exemplars per condition (or do not have categorical conditions at all). With respect to the importance of analysis technique: when applying machine learning analyses to fMRI data, people often prefer to split their trials across many (short) runs and — if using a categorical design — prefer to estimate a single pattern per run. This is because samples across runs are not temporally autocorrelated, which is an important assumption in machine learning based analyses. Lastly, for any pattern analysis, averaging across different trials will increase the signal-to-noise ratio (SNR) for any sample (because you average out noise), but will decrease the statistical power of the analysis (because you have fewer samples).</p>
<p>Long story short: whatever you treat as a sample — single trials, (runwise) exemplars or (runwise) conditions — depends on your design, research question, and analysis technique. In the rest of the tutorial, we will usually refer to samples as “trials”, as this scenario is easiest to simulate and visualize, but remember that this term may equally well refer to (runwise) exemplar-average or condition-average patterns.</p>
<hr class="docutils" />
<p>To make the issue of estimating patterns from time series a little more concrete, let’s simulate some signals. We’ll assume that we have a very simple experiment with two conditions (A, B) with ten trials each (interleaved, i.e., ABABAB…AB), a trial duration of 1 second, spaced evenly within a single run of 200 seconds (with a TR of 2 seconds, so 100 timepoints). Note that you are not necessarily limited to discrete categorical designs for all pattern analyses! While for machine learning-based methods (topic of week 2) it is common to have a design with a single categorical feature of interest (or some times a single continuous one),  representional similarity analyses (topic of week 3) are often applied to data with more “rich” designs (i.e., designs that include many, often continuously varying, factors of interest). Also, using twenty trials is probably way too few for any pattern analysis, but it’ll make the examples (and visualizations) in this section easier to understand.</p>
<p>Alright, let’s get to it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TR</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># 2 x 10 trials</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># duration in seconds</span>

<span class="c1"># t_pad is a little baseline at the </span>
<span class="c1"># start and end of the run</span>
<span class="n">t_pad</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">onsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">t_pad</span><span class="p">,</span> <span class="n">T</span> <span class="o">-</span> <span class="n">t_pad</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">durations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">onsets</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Onsets:&quot;</span><span class="p">,</span> <span class="n">onsets</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conditions:&quot;</span><span class="p">,</span> <span class="n">conditions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Onsets: [ 10.  19.  28.  37.  46.  55.  64.  73.  82.  91. 100. 109. 118. 127.
 136. 145. 154. 163. 172. 181.]

Conditions: [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;]
</pre></div>
</div>
</div>
</div>
<p>We’ll use the <code class="docutils literal notranslate"><span class="pre">simulate_signal</span></code> function used in the introductory course to simulate the data. This function is like a GLM in reverse: it assumes that a signal (<span class="math notranslate nohighlight">\(R\)</span>) is generated as a linear combination between (HRF-convolved) experimental features (<span class="math notranslate nohighlight">\(\mathbf{S}\)</span>) weighted by some parameters ( <span class="math notranslate nohighlight">\(\beta\)</span> ) plus some additive noise (<span class="math notranslate nohighlight">\(\epsilon\)</span>), and simulates the signal accordingly (you can check out the function by running <code class="docutils literal notranslate"><span class="pre">simulate_signal??</span></code> in a new code cell).</p>
<p>Because we simulate the signal, we can use “ground-truth” activation parameters ( <span class="math notranslate nohighlight">\(\beta\)</span> ). In this simulation, we’ll determine that the signal responds more strongly to trials of condition A (<span class="math notranslate nohighlight">\(\beta = 0.8\)</span>) than trials of condition B (<span class="math notranslate nohighlight">\(\beta = 0.2\)</span>) in <em>even</em> voxels (voxel 0, 2, etc.) and vice versa for <em>odd</em> voxels (voxel 1, 3, etc.):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params_even</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">params_odd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">params_even</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-info'>
    <b>ToThink</b> (0 points): Given these simulation parameters, what do you think that the corresponding $N\times K$ pattern array ($\mathbf{R}$) would roughly look like visually (assuming an efficient pattern estimation method)?
</div><p>Alright, We simulate some data for, let’s say, four voxels (<span class="math notranslate nohighlight">\(K = 4\)</span>). (Again, you’ll usually perform pattern analyses on many more voxels.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.utils.nii</span> <span class="kn">import</span> <span class="n">simulate_signal</span>
<span class="n">K</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">ts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>

    <span class="c1"># Google &quot;Python modulo&quot; to figure out</span>
    <span class="c1"># what the line below does!</span>
    <span class="n">is_even</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    
    <span class="n">sig</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">simulate_signal</span><span class="p">(</span>
        <span class="n">onsets</span><span class="p">,</span>
        <span class="n">conditions</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="n">T</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">std_noise</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">params_canon</span><span class="o">=</span><span class="n">params_even</span> <span class="k">if</span> <span class="n">is_even</span> <span class="k">else</span> <span class="n">params_odd</span>
    <span class="p">)</span>

    <span class="n">ts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>

<span class="c1"># ts = timeseries</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape of simulated signals: &quot;</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape of simulated signals:  (100, 4)
</pre></div>
</div>
</div>
</div>
<p>And let’s plot these voxels. We’ll show the trial onsets as arrows (red = condition A, orange = condition B):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="c1"># Plot signal</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="c1"># Plot trial onsets (as arrows)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onsets</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;tab:orange&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">to</span> <span class="o">/</span> <span class="n">TR</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
<span class="c1"># Common axis labels</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.425</span><span class="p">,</span> <span class="o">-</span><span class="mf">.03</span><span class="p">,</span> <span class="s2">&quot;Activation (A.U.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f06b8ca4a473a51b19750b092c7945ed4564bc0e51fd5c2fd79faf1d64a3de26.png" src="../../_images/f06b8ca4a473a51b19750b092c7945ed4564bc0e51fd5c2fd79faf1d64a3de26.png" />
</div>
</div>
<div class='alert alert-success'>
    <b>Tip</b>: Matplotlib is a very flexible plotting package, but arguably at the expense of how fast you can implement something. <a href="https://seaborn.pydata.org/">Seaborn</a> is a great package (build on top of Matplotlib) that offers some neat functionality that makes your life easier when plotting in Python. For example, we used the <tt>despine</tt> function to remove the top and right spines to make our plot a little nicer. In this course, we'll mostly use Matplotlib, but we just wanted to make you aware of this awesome package.
</div><p>Alright, now we can start discussing methods for pattern estimation! Unfortunately, as pattern analyses are relatively new, there no concensus yet about the “best” method for pattern estimation. In fact, there exist many different methods, which we can roughly divided into two types:</p>
<ol class="arabic simple">
<li><p>Timepoint-based method (for lack of a better name) and</p></li>
<li><p>GLM-based methods</p></li>
</ol>
<p>We’ll discuss both of them, but spend a little more time on the latter set of methods as they are more complicated (and are more popular).</p>
</div>
<div class="section" id="timepoint-based-methods">
<h3>Timepoint-based methods<a class="headerlink" href="#timepoint-based-methods" title="Permalink to this heading">#</a></h3>
<p>Timepoint-based methods “extract” patterns by simply using a single timepoint (e.g., 6 seconds after stimulus presentation) or (an average of) multiple timepoints (e.g., 4, 6, and 8 seconds after stimulus presentation).</p>
<p>Below, we visualize what a single-timepoint method would look like (assuming that we’d want to extract the timepoint 6 seconds after stimulus presentation, i.e., around the assumed peak of the BOLD response). The stars represent the values that we would extract (red when condition A, orange when condition B). Note, we only plot the first 60 volumes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">t_fmri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="c1"># Plot signal</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="c1"># Plot trial onsets (as arrows)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onsets</span><span class="p">):</span>
        <span class="n">plus6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">to</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">t_fmri</span><span class="p">,</span> <span class="n">ts</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;tab:orange&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">to</span> <span class="o">/</span> <span class="n">TR</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">plus6</span><span class="p">,</span> <span class="n">plus6</span><span class="p">],</span> <span class="p">[(</span><span class="n">to</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">TR</span><span class="p">,</span> <span class="p">(</span><span class="n">to</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">TR</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Common axis labels</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.425</span><span class="p">,</span> <span class="o">-</span><span class="mf">.03</span><span class="p">,</span> <span class="s2">&quot;Activation (A.U.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2e5fbaca14ecf89eaca538f32d106446af6df7ca4ef4e684f004546c186109b2.png" src="../../_images/2e5fbaca14ecf89eaca538f32d106446af6df7ca4ef4e684f004546c186109b2.png" />
</div>
</div>
<p>Now, extracting these timepoints 6 seconds after stimulus presentation is easy when this timepoint is a multiple of the scan’s TR (here: 2 seconds). For example, to extract the value for the first trial (onset: 10 seconds), we simply take the 8th value in our timeseries, because <span class="math notranslate nohighlight">\((10 + 6) / 2 = 8\)</span>. But what if our trial onset + 6 seconds is <em>not</em> a multiple of the TR, such as with trial 2 (onset: 19 seconds)? Well, we can interpolate this value! We will use the same function for this operation as we did for slice-timing correction (from the previous course): <code class="docutils literal notranslate"><span class="pre">interp1d</span></code> from the <code class="docutils literal notranslate"><span class="pre">scipy.interpolate</span></code> module.</p>
<p>To refresh your memory: this function takes the timepoints associated with the values (or “frame_times” in Nilearn lingo) and the values itself to generate a new object which we’ll later use to do the actual (linear) interpolation. First, let’s define the timepoints:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_fmri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (1 point): The above timepoints assume that all data was acquired at the onset of the volume acquisition ($t=0$, $t=2$, etc.). Suppose that we actually slice-time corrected our data to the middle slice, i.e., the 18th slice (out of 36 slices) &mdash; create a new array (using <tt>np.linspace</tt> with timepoints that reflect these slice-time corrected acquisition onsets) and store it in a variable named <tt>t_fmri_middle_slice</tt>.
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_frame_times_stc</span>
<span class="n">test_frame_times_stc</span><span class="p">(</span><span class="n">TR</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_fmri_middle_slice</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For now, let’s assume that all data was actually acquired at the start of the volume (<span class="math notranslate nohighlight">\(t=0\)</span>, <span class="math notranslate nohighlight">\(t=2\)</span>, etc.). We can “initialize” our interpolator by giving it both the timepoints (<code class="docutils literal notranslate"><span class="pre">t_fmri</span></code>) and the data (<code class="docutils literal notranslate"><span class="pre">ts</span></code>). Note that <code class="docutils literal notranslate"><span class="pre">ts</span></code> is not a single time series, but a 2D array with time series for four voxels (across different columns). By specifying <code class="docutils literal notranslate"><span class="pre">axis=0</span></code>, we tell <code class="docutils literal notranslate"><span class="pre">interp1d</span></code> that the first axis represents the axis that we want to interpolate later:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="n">interpolator</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">t_fmri</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can give the <code class="docutils literal notranslate"><span class="pre">interpolator</span></code> object any set of timepoints and it will return the linearly interpolated values associated with these timepoints for all four voxels. Let’s do this for our trial onsets plus six seconds:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onsets_plus_6</span> <span class="o">=</span> <span class="n">onsets</span> <span class="o">+</span> <span class="mi">6</span>
<span class="n">R_plus6</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">onsets_plus_6</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape extracted pattern:&quot;</span><span class="p">,</span> <span class="n">R_plus6</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R_plus6</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Feature value&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathbf</span><span class="si">{R}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Trials&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape extracted pattern: (20, 4)
</pre></div>
</div>
<img alt="../../_images/ef1a56a58923601dcffc663a1966dd56f7a61891a1be0c6daf7720fdd0cc53ad.png" src="../../_images/ef1a56a58923601dcffc663a1966dd56f7a61891a1be0c6daf7720fdd0cc53ad.png" />
</div>
</div>
<p>Yay, we have extracted our first pattern! Does it look like what you expected given the known mean amplitude of the trials from the two conditions (<span class="math notranslate nohighlight">\(\beta_{\mathrm{A,even}} = 0.8, \beta_{\mathrm{B,even}} = 0.2\)</span> and vice versa for odd voxels)?</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (3 points): An alternative to the single-timepoint method is to extract, per trial, the <em>average</em> activity within a particular time window, for example 5-7 seconds post-stimulus. One way to do this is by perform interpolation in steps of (for example) 0.1 within the 5-7 post-stimulus time window (i.e., $5.0, 5.1, 5.2, \dots , 6.8, 6.9, 7.0$) and subsequently averaging these values, per trial, into a single activity estimate. Below, we defined these different steps (<tt>t_post_stimulus</tt>) for you already. Use the <tt>interpolator</tt> object to extract the timepoints for these different post-stimulus times relative to our onsets (<tt>onsets</tt> variable) from our data (<tt>ts</tt> variable). Store the extracted patterns in a new variable called <tt>R_av</tt>.
<p>Note: this is a relatively difficult ToDo! Consider skipping it if it takes too long.</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="n">t_post_stimulus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t_post_stimulus</span><span class="p">)</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_average_extraction</span>
<span class="n">test_average_extraction</span><span class="p">(</span><span class="n">onsets</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">t_post_stimulus</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">,</span> <span class="n">R_av</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These timepoint-based methods are relatively simple to implement and computationally efficient. Another variation that you might see in the literature is that extracted (averages of) timepoints are baseline-subtracted (<span class="math notranslate nohighlight">\(\mathbf{R}_{i} - \mathrm{baseline}_{i}\)</span>) or baseline-normalized (<span class="math notranslate nohighlight">\(\frac{\mathbf{R}_{i}}{\mathrm{baseline}_{i}}\)</span>), where the baseline is usually chosen to be at the stimulus onset or a small window before the stimulus onset. This technique is, as far as we know, not very popular, so we won’t discuss it any further in this lab.</p>
</div>
<div class="section" id="glm-based-methods">
<h3>GLM-based methods<a class="headerlink" href="#glm-based-methods" title="Permalink to this heading">#</a></h3>
<p>One big disadvantage of timepoint-based methods is that it cannot disentangle activity due to different sources (such as trials that are close in time), which is a major problem for fast (event-related) designs. For example, if you present a trial at <span class="math notranslate nohighlight">\(t=10\)</span> and another at <span class="math notranslate nohighlight">\(t=12\)</span> and subsequently extract the pattern six seconds post-stimulus (at <span class="math notranslate nohighlight">\(t=18\)</span> for the second trial), then the activity estimate for the second trial is definitely going to contain activity due to the first trial because of the sluggishness of the HRF.</p>
<p>As such, nowadays GLM-based pattern estimation techniques, which <em>can</em> disentangle the contribution of different sources, are more popular than timepoint-based methods. (Although, technically, you can use timepoint-based methods using the GLM with FIR-based designs, but that’s beyond the scope of this course.) Again, there are multiple flavors of GLM-based pattern estimation, of which we’ll discuss the two most popular ones.</p>
<div class="section" id="least-squares-all-lsa">
<h4>Least-squares all (LSA)<a class="headerlink" href="#least-squares-all-lsa" title="Permalink to this heading">#</a></h4>
<p>The most straightforward GLM-based pattern estimation technique is to fit a single GLM with a design matrix that contains one or more regressors for each sample that you want to estimate (in addition to any confound regressors). The estimated parameters (<span class="math notranslate nohighlight">\(\hat{\beta}\)</span>) corresponding to our samples from this GLM — representing the relative (de)activation of each voxel for each trial — will then represent our patterns!</p>
<p>This technique is often reffered to as “least-squares all” (LSA). Note that, as explained before, a sample can refer to either a single trial, a set of repetitions of a particuar exemplar, or even a single condition. For now, we’ll assume that samples refer to single trials. Often, each sample is modelled by a single (canonical) HRF-convolved regressor (but you could also use more than one regressor, e.g., using a basis set with temporal/dispersion derivatives or a FIR-based basis set), so we’ll focus on this approach.</p>
<p>Let’s go back to our simulated data. We have a single run containing 20 trials, so ultimately our design matrix should contain twenty columns: one for every trial. We can use the <code class="docutils literal notranslate"><span class="pre">make_first_level_design_matrix</span></code> function from Nilearn to create the design matrix. Importantly, we should make sure to give a separate and unique “trial_type” values for all our trials. If we don’t do this (e.g., set trial type to the trial condition: “A” or “B”), then Nilearn won’t create separate regressors for our trials.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">make_first_level_design_matrix</span>

<span class="c1"># We have to create a dataframe with onsets/durations/trial_types</span>
<span class="c1"># No need for modulation!</span>
<span class="n">events_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">onsets</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">])</span>
<span class="n">events_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">events_sim</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trial_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

<span class="c1"># lsa_dm = least squares all design matrix</span>
<span class="n">lsa_dm</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span>
    <span class="n">frame_times</span><span class="o">=</span><span class="n">t_fmri</span><span class="p">,</span>  <span class="c1"># we defined this earlier for interpolation!</span>
    <span class="n">events</span><span class="o">=</span><span class="n">events_sim</span><span class="p">,</span>
    <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;glover&#39;</span><span class="p">,</span>
    <span class="n">drift_model</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># assume data is already high-pass filtered</span>
<span class="p">)</span>

<span class="c1"># Check out the created design matrix</span>
<span class="c1"># Note that the index represents the frame times</span>
<span class="n">lsa_dm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trial_01</th>
      <th>trial_02</th>
      <th>trial_03</th>
      <th>trial_04</th>
      <th>trial_05</th>
      <th>trial_06</th>
      <th>trial_07</th>
      <th>trial_08</th>
      <th>trial_09</th>
      <th>trial_10</th>
      <th>...</th>
      <th>trial_12</th>
      <th>trial_13</th>
      <th>trial_14</th>
      <th>trial_15</th>
      <th>trial_16</th>
      <th>trial_17</th>
      <th>trial_18</th>
      <th>trial_19</th>
      <th>trial_20</th>
      <th>constant</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>6.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>190.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.000116</td>
      <td>-0.014879</td>
      <td>0.072992</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>192.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.000031</td>
      <td>-0.006204</td>
      <td>-0.023424</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>194.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-0.000008</td>
      <td>-0.002255</td>
      <td>-0.049163</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>196.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-0.000734</td>
      <td>-0.038630</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>198.0</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>-0.000218</td>
      <td>-0.021623</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 21 columns</p>
</div></div></div>
</div>
<p>Note that the design matrix contains 21 regressors: 20 trialwise regressors and an intercept (the last column). Let’s also plot it using Nilearn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_design_matrix</span>
<span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">lsa_dm</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f1866bdd65792823f2f2639401a6eda111222088913bf97283fdb5a703284b48.png" src="../../_images/f1866bdd65792823f2f2639401a6eda111222088913bf97283fdb5a703284b48.png" />
</div>
</div>
<p>And, while we’re at it, plot it as time series (rather than a heatmap):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lsa_dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;LSA design matrix&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s1">&#39;trial &#39;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;icept&#39;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/65ded7f765dfacc1c953190edf03b6400d0e1ac53ccbe60d74c5ca61602ddc39.png" src="../../_images/65ded7f765dfacc1c953190edf03b6400d0e1ac53ccbe60d74c5ca61602ddc39.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo/ToThink</b> (2 points): One "problem" with LSA-type design matrices, especially in fast event-related designs, is that they are not very statistically <em>efficient</em>, i.e., they lead to relatively high variance estimates of your parameters ($\hat{\beta}$), mainly due to relatively high predictor variance. Because we used a fixed inter-trial interval (here: 9 seconds), the correlation between "adjacent" trials are (approximately) the same. <br>
<p>Compute the correlation between, for example, the predictors associated with trial 1 and trial 2, using the <tt>pearsonr</tt> function imported below, and store it in a variable named <tt>corr_t1t2</tt> (1 point). Then, try to think of a way to improve the efficiency of this particular LSA design and write it down in the cell below the test cell.</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDO here. &#39;&#39;&#39;</span>
<span class="c1"># For more info about the `pearsonr` function, check</span>
<span class="c1"># https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.pearsonr.html</span>
<span class="c1"># Want a challenge? Try to compute the correlation from scratch!</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the ToDo above. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_t1t2_corr</span>
<span class="n">test_t1t2_corr</span><span class="p">(</span><span class="n">lsa_dm</span><span class="p">,</span> <span class="n">corr_t1t2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>YOUR ANSWER HERE</p>
<p>Alright, let’s actually fit the model! When dealing with real fMRI data, we’d use Nilearn to fit our GLM, but for now, we’ll just use our own implementation of an (OLS) GLM. Note that we can actually fit a <em>single</em> GLM for all voxels at the same time by using <code class="docutils literal notranslate"><span class="pre">ts</span></code> (a <span class="math notranslate nohighlight">\(T \times K\)</span> matrix) as our dependent variable due to the magic of linear algebra. In other words, we can run <span class="math notranslate nohighlight">\(K\)</span> OLS models at once!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Let&#39;s use &#39;X&#39;, because it&#39;s shorter</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Note we can fit our GLM for all K voxels at </span>
<span class="c1"># the same time! As such, betas is not a vector,</span>
<span class="c1"># but an n_regressor x k_voxel matrix!</span>
<span class="n">beta_hat_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">ts</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape beta_hat_all:&quot;</span><span class="p">,</span> <span class="n">beta_hat_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Ah, the beta for the intercept is still in there</span>
<span class="c1"># Let&#39;s remove it</span>
<span class="n">beta_icept</span> <span class="o">=</span> <span class="n">beta_hat_all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">beta_hat</span> <span class="o">=</span> <span class="n">beta_hat_all</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape beta_hat (intercept removed):&quot;</span><span class="p">,</span> <span class="n">beta_hat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape beta_hat_all: (21, 4)
Shape beta_hat (intercept removed): (20, 4)
</pre></div>
</div>
</div>
</div>
<p>Alright, let’s visualize the estimated parameters (<span class="math notranslate nohighlight">\(\hat{\beta}\)</span>). We’ll do this by plotting the scaled regressors (i.e., <span class="math notranslate nohighlight">\(X_{j}\hat{\beta}_{j}\)</span>) on top of the original signal. Each differently colored line represents a different regressor (so a different trial):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="c1"># Plot signal</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
    <span class="c1"># Plot trial onsets (as arrows)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">onsets</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;tab:red&#39;</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;tab:orange&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">to</span> <span class="o">/</span> <span class="n">TR</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="c1"># Compute x*beta for icept only </span>
    <span class="n">scaled_icept</span> <span class="o">=</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">beta_icept</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">this_x</span> <span class="o">=</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># Compute x*beta for this particular trial (ii)</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="n">scaled_icept</span> <span class="o">+</span> <span class="n">this_x</span> <span class="o">*</span> <span class="n">beta_hat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Voxel </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (volumes)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Common axis labels</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.425</span><span class="p">,</span> <span class="o">-</span><span class="mf">.03</span><span class="p">,</span> <span class="s2">&quot;Activation (A.U.)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b7cb7cbc54e59e5a6ae728acd76e41c4efd1493c3208567f4455288a14f7f951.png" src="../../_images/b7cb7cbc54e59e5a6ae728acd76e41c4efd1493c3208567f4455288a14f7f951.png" />
</div>
</div>
<p>Ultimately, though, the estimated GLM parameters are just another way to estimate our pattern array (<span class="math notranslate nohighlight">\(\mathbf{R}\)</span>) — this time, we just estimated it using a different method (GLM-based) than before (timepoint-based). Therefore, let’s visualize this array as we did with the other methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">beta_hat</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\hat{\beta}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathbf</span><span class="si">{R}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Trials&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/f972f2b80874ad3c5ff1c65ca4c806404ffdaafb38e54a8c1419c6a05fabc087.png" src="../../_images/f972f2b80874ad3c5ff1c65ca4c806404ffdaafb38e54a8c1419c6a05fabc087.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (optional, 0 points): It would be nice to visualize the patterns, but this is very hard because we have four dimenions (because we have four voxels)! <br><br>PCA to the rescue! Run PCA on the estimated patterns (<tt>beta_hat</tt>) and store the PCA-transformed  array (shape: $20 \times 2$) in a variable named <tt>beta_hat_2d</tt>. Then, try to plot the first two components as a scatterplot. Make it even nicer by plotting the trials from condition A as red points and trials from condition B als orange points. 
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_pca_beta_hat</span>
<span class="n">test_pca_beta_hat</span><span class="p">(</span><span class="n">beta_hat</span><span class="p">,</span> <span class="n">beta_hat_2d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="noise-normalization">
<h4>Noise normalization<a class="headerlink" href="#noise-normalization" title="Permalink to this heading">#</a></h4>
<p>One often used preprocessing step for pattern analyses (using GLM-estimation methods) is to use “noise normalization” on the estimated patterns. There are two flavours: “univariate” and “multivariate” noise normalization. In univariate noise normalization, the estimated parameters (<span class="math notranslate nohighlight">\(\hat{\beta}\)</span>) are divided (normalized) by the standard deviation of the estimated parameters — which you might recognize as the formula for <span class="math notranslate nohighlight">\(t\)</span>-values (for a contrast against baseline)!</p>
<div class="amsmath math notranslate nohighlight" id="equation-22bf3fe1-255e-4e00-aeee-13c37cef8120">
<span class="eqno">(89)<a class="headerlink" href="#equation-22bf3fe1-255e-4e00-aeee-13c37cef8120" title="Permalink to this equation">#</a></span>\[\begin{align}
t_{c\hat{\beta}} = \frac{c\hat{\beta}}{\sqrt{\hat{\sigma}^{2}c(X^{T}X)^{-1}c^{T}}}
\end{align}\]</div>
<p>where <span class="math notranslate nohighlight">\(\hat{\sigma}^{2}\)</span> is the estimate of the error variance (sum of squared errors divided by the degrees of freedom) and <span class="math notranslate nohighlight">\(c(X^{T}X)^{-1}c^{T}\)</span> is the “design variance”. Sometimes people disregard the design variance and the degrees of freedom (DF) and instead only use the standard deviation of the noise:</p>
<div class="amsmath math notranslate nohighlight" id="equation-0c0e7857-673f-470a-9c06-959849a55111">
<span class="eqno">(90)<a class="headerlink" href="#equation-0c0e7857-673f-470a-9c06-959849a55111" title="Permalink to this equation">#</a></span>\[\begin{align}
t_{c\hat{\beta}} \approx \frac{c\hat{\beta}}{\sqrt{\sum (y_{i} - X_{i}\hat{\beta})^{2}}}
\end{align}\]</div>
<div class='alert alert-info'>
    <b>ToThink</b> (1 point): When experiments use a fixed ISI (in the context of single-trial GLMs), the omission of the design variance in univariate noise normalization is warranted. Explain why.
</div><p>YOUR ANSWER HERE</p>
<p>Either way, this univariate noise normalization is a way to “down-weigh” the uncertain (noisy) parameter estimates. Although this type of univariate noise normalization seems to lead to better results in both decoding and RSA analyses (e.g., <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pubmed/20580933">Misaki et al., 2010</a>), the jury is still out on this issue.</p>
<p>Multivariate noise normalization will be discussed in week 3 (RSA), so let’s focus for now on the implementation of univariate noise normalization using the approximate method (which disregards design variance). To compute the standard deviation of the noise (<span class="math notranslate nohighlight">\(\sqrt{\sum (y_{i} - X_{i}\hat{\beta})^{2}}\)</span>), we first need to compute the noise, i.e., the unexplained variance (<span class="math notranslate nohighlight">\(y - X\hat{\beta}\)</span>) also known as the residuals:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">residuals</span> <span class="o">=</span> <span class="n">ts</span> <span class="o">-</span> <span class="n">X</span> <span class="o">@</span> <span class="n">beta_hat_all</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape residuals:&quot;</span><span class="p">,</span> <span class="n">residuals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape residuals: (100, 4)
</pre></div>
</div>
</div>
</div>
<p>So, for each voxel (<span class="math notranslate nohighlight">\(K=4\)</span>), we have a timeseries (<span class="math notranslate nohighlight">\(T=100\)</span>) with unexplained variance (“noise”). Now, to get the standard deviation across all voxels, we can do the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">std_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape noise std:&quot;</span><span class="p">,</span> <span class="n">std_noise</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape noise std: (4,)
</pre></div>
</div>
</div>
</div>
<p>To do the actual normalization step, we simply divide the columns of the pattern matrix (<code class="docutils literal notranslate"><span class="pre">beta_hat</span></code>, which we estimated before) by the estimated noise standard deviation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># unn = univariate noise normalization</span>
<span class="c1"># Note that we don&#39;t have to do this for each trial (row) separately</span>
<span class="c1"># due to Numpy broadcasting!</span>
<span class="n">R_unn</span> <span class="o">=</span> <span class="n">beta_hat</span> <span class="o">/</span> <span class="n">std_noise</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape R_unn:&quot;</span><span class="p">,</span> <span class="n">R_unn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Shape R_unn: (20, 4)
</pre></div>
</div>
</div>
</div>
<p>And let’s visualize it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R_unn</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$t$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathbf</span><span class="si">{R}</span><span class="s2">_</span><span class="si">{unn}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voxels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Trials&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/81727e453c15ece2663271aa93fc2e485eb23219247768900a0cdcf291b0da10.png" src="../../_images/81727e453c15ece2663271aa93fc2e485eb23219247768900a0cdcf291b0da10.png" />
</div>
</div>
<div class='alert alert-info'>
    <b>ToThink</b> (1 point): In fact, univariate noise normalization didn't really change the pattern matrix much. Why do you think this is the case for our simulation data? Hint: check out the parameters for the simulation.
</div><p>YOUR ANSWER HERE</p>
</div>
<div class="section" id="lsa-on-real-data">
<h4>LSA on real data<a class="headerlink" href="#lsa-on-real-data" title="Permalink to this heading">#</a></h4>
<p>Alright, enough with all that fake data — let’s work with some real data! We’ll use the face perception task data from the <em>NI-edu</em> dataset, which we briefly mentioned in the fMRI-introduction course.</p>
<p>In the face perception task, participants were presented with images of faces (from the publicly available <a class="reference external" href="https://figshare.com/articles/Face_Research_Lab_London_Set/5047666">Face Research Lab London Set</a>). In total, frontal face images from 40 different people (“identities”) were used, which were either without expression (“neutral”) or were smiling. Each face image (from in total 80 faces, i.e., 40 identities <span class="math notranslate nohighlight">\(\times\)</span> 2, neutral/smiling) was shown, per participant, 6 times across the 12 runs (3 times per session).</p>
<div class='alert alert-info'>
    <b>Mini ToThink</b> (0 points): Why do you think we show the same image multiple times?
</div><p>Identities were counterbalanced in terms of biological sex (male vs. female) and ethnicity (Caucasian vs. East-Asian vs. Black). The Face Research Lab London Set also contains the age of the people in the stimulus dataset and (average) attractiveness ratings for all faces from an independent set of raters. In addition, we also had our own participants rate the faces on perceived attractiveness, dominance, and trustworthiness after each session (rating each face, on each dimension, four times in total for robustness). The stimuli were chosen such that we have many different attributes that we could use to model brain responses (e.g., identity, expression, ethnicity, age, average attractiveness, and subjective/personal perceived attractiveness/dominance/trustworthiness).</p>
<p>In this paradigm, stimuli were presented for 1.25 seconds and had a fixed interstimulus interval (ISI) of 3.75 seconds. While sub-optimal for univariate “detection-based” analyses, we used a fixed ISI — rather than jittered — to make sure it can also be used for “single-trial” multivariate analyses. Each run contained 40 stimulus presentations. To keep the participants attentive, a random selection of 5 stimuli (out of 40) were followed by a rating on either perceived attractiveness, dominance, or trustworthiness using a button-box with eight buttons (four per hand) lasting 2.5 seconds. After the rating, a regular ISI of 3.75 seconds followed. See the figure below for a visualization of the paradigm.</p>
<p><img alt="face_paradigm" src="https://docs.google.com/drawings/d/e/2PACX-1vQ0FlwZLI_XMHaKkaNchzZvgqT0JXjZAPbH9fccmNvgey-RYR5bKolh85Wctc2YLrjOLtE3Zkd7WXdu/pub?w=1429&amp;h=502" /></p>
<p>First, let’s set up all the data that we need for our LSA model. Let’s see where our data is located:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;NI-edu-data&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading Fmriprep data (+- 175MB) ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;sub-03/ses-1/func/*task-face*run-1*events.tsv&quot;</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;derivatives/fmriprep/sub-03/ses-1/func/*task-face*run-1*space-T1w*bold.nii.gz&quot;</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;derivatives/fmriprep/sub-03/ses-1/func/*task-face*run-1*space-T1w*mask.nii.gz&quot;</span>
<span class="o">!</span>aws<span class="w"> </span>s3<span class="w"> </span>sync<span class="w"> </span>--no-sign-request<span class="w"> </span>s3://openneuro.org/ds003965<span class="w"> </span><span class="o">{</span>data_dir<span class="o">}</span><span class="w"> </span>--exclude<span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="w"> </span>--include<span class="w"> </span><span class="s2">&quot;derivatives/fmriprep/sub-03/ses-1/func/*task-face*run-1*confounds_timeseries.tsv&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading Fmriprep data (+- 175MB) ...
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Done!
</pre></div>
</div>
</div>
</div>
<p>As you can see, it contains both “raw” (not-preprocessed) subject data (e.g., sub-03) and derivatives, which include Fmriprep-preprocessed data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fprep_sub03</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fmriprep&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contents derivatives/fmriprep/sub-03:&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fprep_sub03</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Contents derivatives/fmriprep/sub-03: [&#39;ses-1&#39;]
</pre></div>
</div>
</div>
</div>
<p>There is preprocessed anatomical data and session-specific functional data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fprep_sub03_ses1_func</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fprep_sub03</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">)</span>
<span class="n">contents</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fprep_sub03_ses1_func</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Contents ses-1/func:&quot;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contents</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Contents ses-1/func: sub-03_ses-1_task-face_run-1_desc-confounds_timeseries.tsv
sub-03_ses-1_task-face_run-1_space-T1w_desc-brain_mask.nii.gz
sub-03_ses-1_task-face_run-1_space-T1w_desc-preproc_bold.nii.gz
</pre></div>
</div>
</div>
</div>
<p>That’s a lot of data! Importantly, we will only use the “face” data (“task-face”) in T1 space (“space-T1w”), meaning that this dat has not been normalized to a common template (unlike the “task-MNI152NLin2009cAsym” data). Here, we’ll only analyze the first run (“run-1”) data. Let’s define the functional data, the associated functional brain mask (a binary image indicating which voxels are brain and which are not), and the file with timepoint-by-timepoint confounds (such as motion parameters):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">func</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fprep_sub03_ses1_func</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_task-face_run-1_space-T1w_desc-preproc_bold.nii.gz&#39;</span><span class="p">)</span>

<span class="c1"># Notice this neat little trick: we use the string method &quot;replace&quot; to define</span>
<span class="c1"># the functional brain mask</span>
<span class="n">func_mask</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-brain_mask&#39;</span><span class="p">)</span>

<span class="n">confs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fprep_sub03_ses1_func</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_task-face_run-1_desc-confounds_timeseries.tsv&#39;</span><span class="p">)</span>
<span class="n">confs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">confs</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">confs_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>global_signal</th>
      <th>global_signal_derivative1</th>
      <th>global_signal_derivative1_power2</th>
      <th>global_signal_power2</th>
      <th>csf</th>
      <th>csf_derivative1</th>
      <th>csf_derivative1_power2</th>
      <th>csf_power2</th>
      <th>white_matter</th>
      <th>white_matter_derivative1</th>
      <th>...</th>
      <th>rot_x_derivative1_power2</th>
      <th>rot_y</th>
      <th>rot_y_derivative1</th>
      <th>rot_y_derivative1_power2</th>
      <th>rot_y_power2</th>
      <th>rot_z</th>
      <th>rot_z_derivative1</th>
      <th>rot_z_power2</th>
      <th>rot_z_derivative1_power2</th>
      <th>motion_outlier00</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>32452.228653</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.053147e+09</td>
      <td>56448.645321</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.186450e+09</td>
      <td>33477.742348</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>-0.000291</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>8.450358e-08</td>
      <td>0.000421</td>
      <td>NaN</td>
      <td>1.770558e-07</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>32374.326829</td>
      <td>-77.901823</td>
      <td>6068.694064</td>
      <td>1.048097e+09</td>
      <td>55903.557212</td>
      <td>-545.088109</td>
      <td>297121.046798</td>
      <td>3.125208e+09</td>
      <td>33461.938656</td>
      <td>-15.803692</td>
      <td>...</td>
      <td>5.203235e-46</td>
      <td>0.000048</td>
      <td>3.383386e-04</td>
      <td>1.144730e-07</td>
      <td>2.269913e-09</td>
      <td>0.000000</td>
      <td>-0.000421</td>
      <td>0.000000e+00</td>
      <td>1.770558e-07</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>32328.138891</td>
      <td>-46.187938</td>
      <td>2133.325610</td>
      <td>1.045109e+09</td>
      <td>55694.677005</td>
      <td>-208.880207</td>
      <td>43630.940942</td>
      <td>3.101897e+09</td>
      <td>33447.470231</td>
      <td>-14.468426</td>
      <td>...</td>
      <td>1.588104e-08</td>
      <td>0.000048</td>
      <td>-4.410000e-08</td>
      <td>1.944810e-15</td>
      <td>2.265712e-09</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>32310.910024</td>
      <td>-17.228868</td>
      <td>296.833887</td>
      <td>1.043995e+09</td>
      <td>55575.853868</td>
      <td>-118.823136</td>
      <td>14118.937749</td>
      <td>3.088676e+09</td>
      <td>33432.562277</td>
      <td>-14.907954</td>
      <td>...</td>
      <td>4.992468e-07</td>
      <td>0.000490</td>
      <td>4.422145e-04</td>
      <td>1.955537e-07</td>
      <td>2.399178e-07</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>32294.584213</td>
      <td>-16.325811</td>
      <td>266.532092</td>
      <td>1.042940e+09</td>
      <td>55408.908249</td>
      <td>-166.945619</td>
      <td>27870.839776</td>
      <td>3.070147e+09</td>
      <td>33414.449996</td>
      <td>-18.112281</td>
      <td>...</td>
      <td>1.071489e-07</td>
      <td>-0.000084</td>
      <td>-5.736183e-04</td>
      <td>3.290380e-07</td>
      <td>7.023161e-09</td>
      <td>0.000170</td>
      <td>0.000170</td>
      <td>2.889184e-08</td>
      <td>2.889184e-08</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>337</th>
      <td>31946.939473</td>
      <td>-20.991637</td>
      <td>440.648839</td>
      <td>1.020607e+09</td>
      <td>55087.811985</td>
      <td>-49.086685</td>
      <td>2409.502635</td>
      <td>3.034667e+09</td>
      <td>33105.711432</td>
      <td>-29.471095</td>
      <td>...</td>
      <td>5.920900e-08</td>
      <td>0.000089</td>
      <td>-2.001220e-04</td>
      <td>4.004881e-08</td>
      <td>7.944692e-09</td>
      <td>-0.000059</td>
      <td>-0.000192</td>
      <td>3.490033e-09</td>
      <td>3.705336e-08</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>338</th>
      <td>31950.066021</td>
      <td>3.126548</td>
      <td>9.775302</td>
      <td>1.020807e+09</td>
      <td>55027.153585</td>
      <td>-60.658401</td>
      <td>3679.441558</td>
      <td>3.027988e+09</td>
      <td>33103.520451</td>
      <td>-2.190981</td>
      <td>...</td>
      <td>1.318576e-07</td>
      <td>0.000089</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>7.944692e-09</td>
      <td>0.000034</td>
      <td>0.000093</td>
      <td>1.148071e-09</td>
      <td>8.641506e-09</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>339</th>
      <td>31944.702633</td>
      <td>-5.363388</td>
      <td>28.765934</td>
      <td>1.020464e+09</td>
      <td>55133.790131</td>
      <td>106.636546</td>
      <td>11371.352943</td>
      <td>3.039735e+09</td>
      <td>33008.779629</td>
      <td>-94.740822</td>
      <td>...</td>
      <td>4.723668e-08</td>
      <td>0.000089</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>7.944692e-09</td>
      <td>-0.000059</td>
      <td>-0.000093</td>
      <td>3.490033e-09</td>
      <td>8.641506e-09</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>340</th>
      <td>31947.495584</td>
      <td>2.792952</td>
      <td>7.800578</td>
      <td>1.020642e+09</td>
      <td>55189.106597</td>
      <td>55.316466</td>
      <td>3059.911431</td>
      <td>3.045837e+09</td>
      <td>33106.108555</td>
      <td>97.328926</td>
      <td>...</td>
      <td>1.424617e-07</td>
      <td>0.000280</td>
      <td>1.908810e-04</td>
      <td>3.643556e-08</td>
      <td>7.840784e-08</td>
      <td>0.000052</td>
      <td>0.000112</td>
      <td>2.749849e-09</td>
      <td>1.243571e-08</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>341</th>
      <td>31939.892753</td>
      <td>-7.602831</td>
      <td>57.803039</td>
      <td>1.020157e+09</td>
      <td>55111.799336</td>
      <td>-77.307261</td>
      <td>5976.412621</td>
      <td>3.037310e+09</td>
      <td>33035.758455</td>
      <td>-70.350100</td>
      <td>...</td>
      <td>5.988788e-10</td>
      <td>0.000400</td>
      <td>1.198090e-04</td>
      <td>1.435420e-08</td>
      <td>1.598584e-07</td>
      <td>0.000000</td>
      <td>-0.000052</td>
      <td>0.000000e+00</td>
      <td>2.749849e-09</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>342 rows × 231 columns</p>
</div></div></div>
</div>
<p>Finally, we need the events-file with onsets, durations, and trial-types for this particular run:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">events</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;sub-03&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-1&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-03_ses-1_task-face_run-1_events.tsv&#39;</span><span class="p">)</span>
<span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">events_df</span> <span class="o">=</span> <span class="n">events_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;trial_type != &#39;rating&#39; and trial_type != &#39;response&#39;&quot;</span><span class="p">)</span>  <span class="c1"># don&#39;t need this</span>

<span class="c1"># Oops, Nilearn doesn&#39;t accept trial_type values that start with a number, so</span>
<span class="c1"># let&#39;s prepend &#39;tt_&#39; to it!</span>
<span class="n">events_df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tt_&#39;</span> <span class="o">+</span> <span class="n">events_df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now, it’s up to you to use this data to fit an LSA model!</p>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): in this first ToDo, you define your events and the confounds you want to include.<br>
<ol class="arabic simple">
<li><p>Remove all columns except “onset”, “duration”, and “trial_type”. You should end up with a DataFrame with 40 rows and 3 columns. You can check this with the <tt>.shape</tt> attribute of the DataFrame. (Note that, technically, you could model the reponse and rating-related events as well! For now, we’ll exclude them.) Name this filtered DataFrame <tt>events_df_filt</tt>.</p></li>
<li><p>You also need to select specific columns from the confounds DataFrame, as we don’t want to include <em>all</em> confounds! For now, include only the motion parameters (<tt>trans_x, trans_y, trans_z, rot_x, rot_y, rot_z</tt>). You should end up with a confounds DataFrame with 342 rows and 6 columns. Name this filtered DataFrame <tt>confs_df_filt</tt>.</p></li>
</ol>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="k">assert</span><span class="p">(</span><span class="n">events_df_filt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span><span class="n">events_df_filt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;trial_type&#39;</span><span class="p">])</span>
<span class="k">assert</span><span class="p">(</span><span class="n">confs_df_filt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">confs_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="s1">&#39;trans&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="ow">or</span> <span class="s1">&#39;rot&#39;</span> <span class="ow">in</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">confs_df_filt</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Well done!&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): in this Todo, you'll fit your model! Define a <tt>FirstLevelModel</tt> object, name this <tt>flm_todo</tt> and make sure you do the following:<br>
<ol class="arabic simple">
<li><p>Set the correct TR (this is 0.7)</p></li>
<li><p>Set the slice time reference to 0.5</p></li>
<li><p>Set the mask image to the one we defined before</p></li>
<li><p>Use a “glover” HRF</p></li>
<li><p>Use a “cosine” drift model with a cutoff of 0.01 Hz</p></li>
<li><p>Do not apply any smoothing</p></li>
<li><p>Set minimize_memory to true</p></li>
<li><p>Use an “ols” noise model</p></li>
</ol>
<p>Then, fit your model using the functional data (<tt>func</tt>), filtered confounds, and filtered events we defined before.</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="c1"># Ignore the DeprecationWarning!</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">FirstLevelModel</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Tests the above ToDo. &quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_lsa_flm</span>
<span class="n">test_lsa_flm</span><span class="p">(</span><span class="n">flm_todo</span><span class="p">,</span> <span class="n">func_mask</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">events_df_filt</span><span class="p">,</span> <span class="n">confs_df_filt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (2 points): in this Todo, you'll run the single-trial contrasts ("against baseline"). To do so, write a for-loop in which you call the <tt>compute_contrast</tt> method every iteration with a new contrast definition for a new trial. Make sure to output the "betas" (by using <tt>output_type='effect_size'</tt>).
<p>Note that the <tt>compute_contrast</tt> method returns the “unmasked” results (i.e., from all voxels). Make sure that, for each trial, you mask the results using the <tt>func_mask</tt> variable and the <tt>apply_mask</tt> function from Nilearn. Save these masked results (which should be patterns of 66298 voxels) for each trial. After the loop, stack all results in a 2D array with the different trials in different rows and the (flattened) voxels in columns. This array should be of shape 40 (trials) by 65643 (nr. of masked voxels). The variable name of this array should be <tt>R_todo</tt>.</p>
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">nilearn.masking</span> <span class="kn">import</span> <span class="n">apply_mask</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_lsa_R</span>
<span class="n">test_lsa_R</span><span class="p">(</span><span class="n">R_todo</span><span class="p">,</span> <span class="n">events_df_filt</span><span class="p">,</span> <span class="n">flm_todo</span><span class="p">,</span> <span class="n">func_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-success'>
    <b>Disclaimer</b>: In this ToDo, we asked you <em>not</em> to spatially smooth the data. This is often recommended for pattern analyses, as they arguably use information that is encoded in finely distributed patterns. However, several studies have shown that smoothing may sometimes benefit pattern analyses (e.g., <a href="https://www.frontiersin.org/articles/10.3389/fneur.2017.00222/full">Hendriks et al., 2017</a>). In general, in line with the <a href="https://en.wikipedia.org/wiki/Matched_filter">matched filter theorem</a>, we recommend smoothing your data with a kernel equal to how finegrained you think your experimental feature is encoded in the brain patterns.
</div></div>
</div>
</div>
<div class="section" id="dealing-with-trial-correlations">
<h2>Dealing with trial correlations<a class="headerlink" href="#dealing-with-trial-correlations" title="Permalink to this heading">#</a></h2>
<p>When working with single-trial experimental designs (such as the LSA designs discussed previously), one often occurring problem is correlation between trial predictors and their resulting estimates. Trial correlations in such designs occur when the inter-stimulus interval (ISI) is sufficiently short such that trial predictors overlap and thus correlate. This, in turn, leads to relatively unstable (high-variance) pattern estimates and, as we will see later in this section, trial patterns that correlate with each other (which is sometimes called <a class="reference external" href="https://www.biorxiv.org/content/10.1101/032391v2">pattern drift</a>).</p>
<p>This is also the case in our data from the NI-edu dataset. In the “face” task, stimuli were presented for 1.25 seconds, followed by a 3.75 ISI, which causes a slightly positive correlation between a given trial (<span class="math notranslate nohighlight">\(i\)</span>) and the next trial (<span class="math notranslate nohighlight">\(i + 1\)</span>) and a slightly negative correlation between the trial after that (<span class="math notranslate nohighlight">\(i + 2\)</span>). We’ll show this below by visualizing the correlation matrix of the design matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dm_todo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;dm_todo.tsv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">dm_todo</span> <span class="o">=</span> <span class="n">dm_todo</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">40</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Slightly exaggerate by setting the limits to (-.3, .3)</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Some styling</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.825</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3cece8cd27136d9cf5da02e1b9db0f4c2a4efcf912872391aab6594af1408da2.png" src="../../_images/3cece8cd27136d9cf5da02e1b9db0f4c2a4efcf912872391aab6594af1408da2.png" />
</div>
</div>
<div class='alert alert-info'>
    <b>ToThink</b> (1 point): Explain why trials (at index $i$) correlate slightly <em>negatively</em> with the the second trial coming after it (at index $i + 2$). Hint: try to plot it!
</div><p>YOUR ANSWER HERE</p>
<p>The trial-by-trial correlation structure in the design leads to a trial-by-trial correlation structure in the estimated patterns as well (as explained by <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811919310407">Soch et al., 2020</a>). We show this below by computing and visualizing the <span class="math notranslate nohighlight">\(N \times N\)</span> correlation matrix of the patterns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load in R_todo if you didn&#39;t manage to do the</span>
<span class="c1"># previous ToDo</span>
<span class="n">R_todo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;R_todo.npy&#39;</span><span class="p">)</span>

<span class="c1"># Compute the NxN correlation matrix</span>
<span class="n">R_corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">R_todo</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">mapp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">R_corr</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Some styling</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">dm_todo</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mapp</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.825</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Correlation&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/5d8aabdc1f064e68f33585ef0ffa0ae6af41ea3c7753017b23f04a848afdf164.png" src="../../_images/5d8aabdc1f064e68f33585ef0ffa0ae6af41ea3c7753017b23f04a848afdf164.png" />
</div>
</div>
<p>This correlation structure across trials poses a problem for representational similarity analysis (the topic of week 3) especially. Although this issue is still debated and far from solved, in this section we highlight two possible solutions to this problem: least-squares separate designs and temporal “uncorrelation”.</p>
<div class="section" id="least-squares-separate-lss">
<h3>Least-squares separate (LSS)<a class="headerlink" href="#least-squares-separate-lss" title="Permalink to this heading">#</a></h3>
<p>The least-squares separate LSS) design is a slight modifcation of the LSA design (<a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S105381191400768X">Mumford et al., 2014</a>). In LSS, you fit a separate model per trial. Each model contains one regressor for the trial that you want to estimate and, for each condition in your experimental design (in case of a categorical design), another regressor containing all other trials.</p>
<p>So, suppose you have a run with 30 trials across 3 conditions (A, B, and C); using an LSS approach, you’d fit 30 different models, each containing four regressors (one for the single trial, one for all (other) trials of condition A, one for all (other) trials of condition B, and one for all (other) trials of condition C). The apparent upside of this is that it strongly reduces the collinearity of trials close in time, which in turn makes the trial parameters more efficient to estimate.</p>
<div class='alert alert-info'>
    <b>ToThink</b> (1 point): Suppose my experiment contains 90 stimuli which all belong to their own condition (i.e., there are 90 conditions). Explain why LSS provides no improvement over LSA in this case.
</div><p>YOUR ANSWER HERE</p>
<p>We’ll show this for our example data. It’s a bit complicated (and not necessarily the best/fastest/clearest way), but the comments will explain what it’s doing. Essentially, what we’re doing, for each trial, is to extract that regressor for a standard LSA design and, for each condition, create a single regressor by summing all single-trial regressors from that condition together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># First, well make a standard LSA design matrix</span>
<span class="n">lsa_dm</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span>
    <span class="n">frame_times</span><span class="o">=</span><span class="n">t_fmri</span><span class="p">,</span>  <span class="c1"># we defined this earlier for interpolation!</span>
    <span class="n">events</span><span class="o">=</span><span class="n">events_sim</span><span class="p">,</span>
    <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;glover&#39;</span><span class="p">,</span>
    <span class="n">drift_model</span><span class="o">=</span><span class="kc">None</span>  <span class="c1"># assume data is already high-pass filtered</span>
<span class="p">)</span>

<span class="c1"># Then, we will loop across trials, making a single GLM</span>
<span class="n">lss_dms</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># we&#39;ll store the design matrices here</span>

<span class="c1"># Do not include last column, the intercept, in the loop</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsa_dm</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>    
    <span class="c1"># Extract the single-trial predictor</span>
    <span class="n">single_trial_reg</span> <span class="o">=</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>

    <span class="c1"># Now, we need to create a predictor per condition</span>
    <span class="c1"># (one for A, one for B). We&#39;ll store these in &quot;other_regs&quot;</span>
    <span class="n">other_regs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Loop across unique conditions (&quot;A&quot; and &quot;B&quot;)</span>
    <span class="k">for</span> <span class="n">con</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">conditions</span><span class="p">):</span>
        <span class="c1"># Which columns belong to the current condition?</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">con</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        
        <span class="c1"># Make sure NOT to include the trial we&#39;re currently estimating!</span>
        <span class="n">idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Also, exclude the intercept (last column)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Now, extract all N-1 regressors</span>
        <span class="n">con_regs</span> <span class="o">=</span> <span class="n">lsa_dm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
        
        <span class="c1"># And sum them together!</span>
        <span class="c1"># This creates a single predictor for the current</span>
        <span class="c1"># condition</span>
        <span class="n">con_reg_all</span> <span class="o">=</span> <span class="n">con_regs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="c1"># Save for later</span>
        <span class="n">other_regs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con_reg_all</span><span class="p">)</span>

    <span class="c1"># Concatenate the condition regressors (one of A, one for B)</span>
    <span class="n">other_regs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">other_regs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Concatenate the single-trial regressor and two condition regressors</span>
    <span class="n">this_dm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">single_trial_reg</span><span class="p">,</span> <span class="n">other_regs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add back an intercept!</span>
    <span class="n">this_dm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># Give it sensible column names</span>
    <span class="n">this_dm</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trial_to_estimate&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">conditions</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span>

    <span class="c1"># Save for alter</span>
    <span class="n">lss_dms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_dm</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We have created </span><span class="si">%i</span><span class="s2"> design matrices!&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">lss_dms</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>We have created 20 design matrices!
</pre></div>
</div>
</div>
</div>
<p>Alright, now let’s check out the first five design matrices, which should estimate the first five trials and contain 4 regressors each (one for the single trial, two for the separate conditions, and one for the intercept):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">plot_design_matrix</span><span class="p">(</span><span class="n">lss_dms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Design for trial </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/495f9a3c5189484dd92e253f63f9d1b74a53a04b4f81e06971111c914fe4186e.png" src="../../_images/495f9a3c5189484dd92e253f63f9d1b74a53a04b4f81e06971111c914fe4186e.png" />
</div>
</div>
<div class='alert alert-warning'>
    <b>ToDo</b> (optional; 1 bonus point): Can you implement an LSS approach to estimate our patterns on the real data? You can reuse the <tt>flm_todo</tt> you created earlier; the only thing you need to change each time is the design matrix. Because we have 40 trials, you need to fit 40 different models (which takes a while). Note that our experimental design does not necessarily have discrete categories, so your LSS design matrices should only have 3 columns: one for the trial to estimate, one for all other trials, and one for the intercept. After fitting each model, compute the trial-against-baseline contrast for the single trial and save the parameter ("beta") map. Then, after the loop, create the same pattern matrix as the previous ToDo, which should also have the same shape, but name it this time <tt>R_todo_lss</tt>. Note, this is a <em>very</em> hard ToDo if you're not very familiar with Python, but a great way to test your programming skills :-)
</div><div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Implement your ToDo here. Note that we already created the LSA design matrix for you. &#39;&#39;&#39;</span>
<span class="n">func_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="n">n_vol</span> <span class="o">=</span> <span class="n">func_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">lsa_dm</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span>
    <span class="n">frame_times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_vol</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">n_vol</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">events</span><span class="o">=</span><span class="n">events_df_filt</span><span class="p">,</span>
    <span class="n">drift_model</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="c1"># YOUR CODE HERE</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39; Tests the above ToDo. &#39;&#39;&#39;</span>
<span class="kn">from</span> <span class="nn">niedu.tests.nipa.week_1</span> <span class="kn">import</span> <span class="n">test_lss</span>
<span class="n">test_lss</span><span class="p">(</span><span class="n">R_todo_lss</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">flm_todo</span><span class="p">,</span> <span class="n">lsa_dm</span><span class="p">,</span> <span class="n">confs_df_filt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class='alert alert-success'>
    <b>Tip</b>: Programming your own pattern estimation pipeline allows you to be very flexible and is a great way to practice your programming skills, but if you want a more "pre-packaged" tool, I recommend the <a href="https://nibetaseries.readthedocs.io/en/stable/">nibetaseries</a> package. The package's name is derived from a specific analysis technique called "beta-series correlation", which is a type of analysis that allows for resting-state like connectivity analyses of task-based fMRI data (which we won't discuss in this course). For this technique, you need to estimate single-trial activity patterns &mdash; just like we need to do for pattern analyses! I've used this package to estimate patterns for pattern analysis and I highly recommend it!
</div></div>
<div class="section" id="temporal-uncorrelation">
<h3>Temporal uncorrelation<a class="headerlink" href="#temporal-uncorrelation" title="Permalink to this heading">#</a></h3>
<p>Another method to deal with trial-by-trial correlations is the “uncorrelation” method by <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811919310407">Soch and colleagues (2020)</a>. As opposed to the LSS method, the uncorrelation approach takes care of the correlation structure in the data in a post-hoc manner. It does so, in essence, by “removing” the correlations in the data that are due to the correlations in the design in a way that is similar to what prewhitening does in generalized least squares.</p>
<p>Formally, the “uncorrelated” patterns (<span class="math notranslate nohighlight">\(R_{\mathrm{unc}}\)</span>) are estimated by (matrix) multiplying the square root (<span class="math notranslate nohighlight">\(^{\frac{1}{2}}\)</span>) of covariance matrix of the LSA design matrix (<span class="math notranslate nohighlight">\(X^{T}X\)</span>) with the patterns (<span class="math notranslate nohighlight">\(R\)</span>):</p>
<div class="amsmath math notranslate nohighlight" id="equation-a1cb2ff4-308a-4ac1-9800-7cd080fdc9c2">
<span class="eqno">(91)<a class="headerlink" href="#equation-a1cb2ff4-308a-4ac1-9800-7cd080fdc9c2" title="Permalink to this equation">#</a></span>\[\begin{align}
R_{\mathrm{unc}} = (X^{T}X)^{\frac{1}{2}}R
\end{align}\]</div>
<p>Here, <span class="math notranslate nohighlight">\((X^{T}X)^{\frac{1}{2}}\)</span> represents the “whitening” matrix which uncorrelates the patterns. Let’s implement this in code. Note that we can use the <code class="docutils literal notranslate"><span class="pre">sqrtm</span></code> function from the <code class="docutils literal notranslate"><span class="pre">scipy.linalg</span></code> package to take the square root of a matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">sqrtm</span>

<span class="c1"># Design matrix</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dm_todo</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
<span class="n">R_unc</span> <span class="o">=</span> <span class="n">sqrtm</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">@</span> <span class="n">R_todo</span>
</pre></div>
</div>
</div>
</div>
<p>This uncorrelation technique is something we’ll see again in week 3 when we’ll talk about multivariate noise normalization!</p>
<p>Alright, that was it for this lab! We have covered the basics of experimental design and pattern estimation techniques for fMRI data. Note that there are many other (more advanced) things related to pattern estimation that we haven’t discussed, such as standardization of patterns, multivariate noise normalization, <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0896627311007811">hyperalignment</a>, etc. etc. Some of these topics will be discussed in week 2 (decoding) or week 3 (RSA).</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./fMRI-pattern-analysis/week_1"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../../fMRI-introduction/week_7/nilearn_stats.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Statistics with Nilearn</p>
      </div>
    </a>
    <a class="right-next"
       href="../week_2/decoding_analyses.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Machine learning (“decoding”) analyses</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#experimental-design">Experimental design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#within-subject-vs-between-subject-analyses">Within-subject vs. between-subject analyses</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#confounds">Confounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-makes-up-a-pattern">What makes up a “pattern”?</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#patterns-as-points-in-space">Patterns as “points in space”</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-patterns">Estimating patterns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#important-side-note-single-trials-vs-runwise-average-trials">Important side note: single trials vs. (runwise) average trials</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timepoint-based-methods">Timepoint-based methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#glm-based-methods">GLM-based methods</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#least-squares-all-lsa">Least-squares all (LSA)</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#noise-normalization">Noise normalization</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lsa-on-real-data">LSA on real data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#dealing-with-trial-correlations">Dealing with trial correlations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#least-squares-separate-lss">Least-squares separate (LSS)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#temporal-uncorrelation">Temporal uncorrelation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Lukas Snoek
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2021.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>